<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•í™”í•˜ê¸° v1.3</title>
    <style>
        :root { --bg: #1a1a2e; --panel: #16213e; --point: #e94560; --text: #ecf0f1; --money: #f1c40f; --mine: #2ecc71; --hunt: #3498db; --hp: #ff4d4d; --exp: #9b59b6; }
        body { font-family: 'Malgun Gothic', sans-serif; text-align: center; background-color: var(--bg); color: var(--text); padding: 5px; margin: 0; user-select: none; }
        #game-container { background: var(--panel); max-width: 600px; margin: 0 auto; padding: 15px; border-radius: 15px; border: 2px solid var(--point); min-height: 98vh; box-sizing: border-box; position: relative; display: none; }
        /* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) ... */
        .btn-upgrade { background: var(--point); color: white; height: 55px; font-size: 1.2em; margin-bottom: 8px; font-weight: bold; width: 100%; border: none; border-radius: 10px; cursor: pointer; display: block; box-sizing: border-box; }
        .btn-upgrade:disabled { background: #444; cursor: not-allowed; }
        #shop-list { max-height: 400px; overflow-y: auto; padding-right: 5px; margin: 10px 0; border: 1px solid #333; border-radius: 10px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 15px 0; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .cell { aspect-ratio: 1/1; background: #0f3460; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5em; border: 2px solid #1a1a2e; position: relative; }
        .monster-lv { position: absolute; bottom: 1px; right: 1px; font-size: 0.55em; background: rgba(0,0,0,0.8); padding: 1px 3px; border-radius: 3px; }
        #log-container, #battle-log { height: 160px; overflow-y: auto; background: #1a1a2e; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85em; text-align: left; color: #95a5a6; border: 1px solid #333; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 1000; }
        .modal-content { position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); background: var(--panel); border: 2px solid var(--point); padding: 15px; border-radius: 12px; width: 90%; max-width: 420px; }
        .btn-nav { background: #444; color: white; margin-top: 5px; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }
        
        /* [NEW] ìƒë‹¨ ë°” ìŠ¤íƒ€ì¼ ê°œì„  */
        .status-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; font-weight: bold; }
        .bar-outer { background: #333; height: 18px; border-radius: 9px; overflow: hidden; position: relative; border: 1px solid #000; margin-bottom: 4px; }
        #hp-fill { background: var(--hp); height: 100%; width: 100%; transition: 0.3s; }
        #exp-fill { background: var(--exp); height: 100%; width: 0%; transition: 0.3s; }
        .bar-text { position: absolute; width: 100%; left: 0; top: 0; font-size: 0.75em; line-height: 18px; color: white; text-align: center; text-shadow: 1px 1px 2px black; z-index: 2; }
        
        /* ë¡œê·¸ì¸ ìŠ¤íƒ€ì¼ */
        #login-container { max-width: 400px; margin: 100px auto; padding: 30px; background: var(--panel); border: 2px solid var(--point); border-radius: 15px; }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #0f3460; color: white; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; background: var(--point); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .item-card { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .item-icon { width: 50px; height: 50px; margin-right: 12px; border-radius: 5px; object-fit: cover; background: #000; display: flex; align-items: center; justify-content: center; font-size: 1.2em; border: 1px solid #444; }
        .item-btn { width: 58px; padding: 8px 0; font-size: 0.8em; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }
    </style>

    <script src="Database.js"></script>
    <script src="Enhancement_System.js"></script>
    <script src="Combat_System.js"></script>
    <script src="Shop_System.js"></script>
    <script src="mine.js"></script>
</head>
<body>

<div id="login-container">
    <h2 style="color:var(--money);">ğŸ® ê°•í™”í•˜ê¸° v1.3</h2>
    <input type="text" id="login-id" class="login-input" placeholder="ì•„ì´ë””">
    <input type="password" id="login-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <div style="text-align:left; margin-top:10px; color:#aaa;">
        <input type="checkbox" id="auto-login"> <label for="auto-login">ìë™ ë¡œê·¸ì¸</label>
    </div>
    <button class="login-btn" onclick="MainEngine.handleLogin()">ì ‘ì†í•˜ê¸°</button>
</div>

<div id="game-container">
    <div style="background:#0f3460; padding:10px; border-radius:12px; margin-bottom:15px; border-bottom:2px solid var(--point);">
        <div class="status-row">
            <span style="color:var(--money);">ğŸ’° <span id="gold">0</span> G</span>
            <span style="color:var(--mine);">ğŸ§ª íšŒë³µëŸ‰: <span id="potion-val">0</span> (<span id="potion-cnt">0</span>ê°œ)</span>
        </div>
        
        <div class="bar-outer">
            <div id="hp-fill"></div>
            <div class="bar-text">â¤ï¸ HP <span id="hp-val">0</span> / <span id="hp-max">100</span></div>
        </div>
        
        <div class="bar-outer">
            <div id="exp-fill"></div>
            <div class="bar-text">â­ Lv.<span id="user-lv">1</span> (<span id="exp-text">0 / 0</span>)</div>
        </div>
    </div>

    <div id="page-main" class="page active">
        <h1 style="color:var(--money);">ë©”ì¸ ë¡œë¹„</h1>
        <div class="main-menu-btn" onclick="showPage('page-earn')">ğŸ’° ê³¨ë“œìˆ˜ê¸‰ (ì‚¬ëƒ¥/ê´‘ì‚°)</div>
        <div class="main-menu-btn" onclick="showPage('page-upgrade')">ğŸ”¨ ì¥ë¹„ ê°•í™”</div>
        <div class="main-menu-btn" onclick="showPage('page-info')">ğŸ‘¤ ë‚´ ì •ë³´</div>
        <div class="main-menu-btn" style="background:#c0392b;" onclick="MainEngine.fullHeal()">ğŸ¥ ì¹˜ë£Œì†Œ (ì „ì²´ íšŒë³µ)</div>
        <div class="main-menu-btn" style="background:#ffffff; color:#000000;" onclick="showPage('page-shop-select')">ğŸ›’ ìƒì  ì…ì¥</div>
        <button onclick="MainEngine.logout()" style="background:none; border:none; color:#555; cursor:pointer; margin-top:20px; text-decoration:underline;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="page-earn" class="page">
        <h2>ğŸ’° ê³¨ë“œìˆ˜ê¸‰</h2>
        <button class="main-menu-btn" style="background:var(--hunt);" onclick="showPage('page-hunt')">âš”ï¸ ì‚¬ëƒ¥í„° ì…ì¥</button>
        <button class="main-menu-btn" style="background:var(--mine); color:black;" onclick="showPage('page-mine-select')">â›ï¸ ê´‘ì‚° ì…ì¥</button>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-hunt" class="page">
        <h2>âš”ï¸ ì‚¬ëƒ¥í„°</h2>
        <button onclick="CombatSystem.scanHunt()" class="main-menu-btn" style="background:var(--hunt);">ğŸ“¡ ëª¬ìŠ¤í„° íƒìƒ‰</button>
        <div id="hunt-grid" class="grid-5"></div>
        <div id="battle-log">ì „íˆ¬ ëŒ€ê¸° ì¤‘...</div>
        <button class="btn-nav" onclick="showPage('page-earn')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-mine-select" class="page">
        <h2>â›ï¸ ê´‘ì‚° ì„ íƒ</h2>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="main-menu-btn" style="background:#7f8c8d;" onclick="MiningSystem.enter(0)">1. ê³ ê°ˆëœ ê´‘ì‚° (1,000G)</button>
            <button class="main-menu-btn" style="background:#95a5a6;" onclick="MiningSystem.enter(1)">2. ë¬´ë„ˆì§„ ê´‘ì‚° (10,000G)</button>
            <button class="main-menu-btn" style="background:var(--mine); color:black;" onclick="MiningSystem.enter(2)">3. ë¹›ë‚˜ëŠ” ê´‘ì‚° (100,000G)</button>
            <button class="main-menu-btn" style="background:#f1c40f; color:black;" onclick="MiningSystem.enter(3)">4. ì°¬ë€í•œ ê´‘ì‚° (500,000G)</button>
        </div>
        <button class="btn-nav" onclick="showPage('page-earn')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-mine-play" class="page">
        <h2 id="mine-title">ì±„êµ´ ì¤‘</h2>
        <div id="mine-grid" class="grid-4"></div>
        <button id="mine-refresh" class="btn-nav" style="background:var(--mine); color:black; display:none;" onclick="MiningSystem.refresh()">ìƒˆë¡œìš´ ê´‘ë§¥ íƒìƒ‰</button>
        <button class="btn-nav" onclick="showPage('page-mine-select')">â¬…ï¸ ë‚˜ê°€ê¸°</button>
    </div>

    <div id="page-upgrade" class="page">
        <h2>ğŸ”¨ ì¥ë¹„ ê°•í™”</h2>
        <div id="upgrade-target-display">ê°•í™”í•  ì¥ë¹„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        <button onclick="MainEngine.openInventoryModal()" class="btn-nav" style="background:var(--hunt);">ğŸ“¦ ì¸ë²¤í† ë¦¬ íŒì—…</button>
        <div style="display:flex; justify-content:space-between; margin:10px 0; font-weight:bold;">
            <span style="color:#4ecca3;">ì„±ê³µ: <span id="up-chance">0</span>%</span>
            <span style="color:var(--point);">íŒŒê´´: <span id="up-break">0</span>%</span>
        </div>
        <button class="btn-upgrade" id="btn-up-exec" onclick="UpgradeSystem.try()" disabled>ê°•í™”í•˜ê¸°</button>
        <button class="btn-nav" style="background:#3498db;" id="auto-btn" onclick="UpgradeSystem.startAuto()">ìë™ ê°•í™” ì‹œì‘</button>
        <button class="btn-nav" id="btn-up-sell" style="background:#c0392b; display:none;" onclick="MainEngine.sellFromUpgrade()">ì•„ì´í…œ íŒë§¤</button>
        <div id="log-container">ì‹œìŠ¤í…œ: ì¤€ë¹„ ì™„ë£Œ.</div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="page-info" class="page">
        <h2>ğŸ‘¤ ë‚´ ì •ë³´</h2>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:15px; text-align:left; font-size:0.95em;">
            <p>âš”ï¸ ê³µê²©ë ¥: <span id="info-atk">0</span> | ğŸ›¡ï¸ ë°©ì–´ë ¥: <span id="info-def">0</span></p>
            <p>â¤ï¸ ì²´ë ¥: <span id="info-hp">0</span></p>
        </div>
        <h3>ğŸ’ ì¸ë²¤í† ë¦¬</h3>
        <div id="inventory-list"></div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-shop-select" class="page">
        <h2>ğŸª ìƒì  ì„ íƒ</h2>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="main-menu-btn" onclick="ShopSystem.open('equip')">âš”ï¸ ì¥ë¹„ ìƒì </button>
            <button class="main-menu-btn" style="background:var(--hunt);" onclick="ShopSystem.open('consume')">ğŸ§ª ì†Œë¹„ ìƒì </button>
        </div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="page-shop-detail" class="page">
        <h2 id="shop-title">ìƒì </h2>
        <div id="shop-list"></div>
        <button class="btn-nav" onclick="showPage('page-shop-select')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="inv-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¦ ê°•í™” ëŒ€ìƒ ì„ íƒ</h3>
            <div id="modal-item-list" style="max-height:300px; overflow-y:auto;"></div>
            <button class="btn-nav" onclick="MainEngine.closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    var currentUser = null, data = null, upIdx = -1, autoTimer = null;

    const MainEngine = {
        init: () => {
            if(typeof GameDatabase === 'undefined') return console.error("DB ë¡œë“œ ì‹¤íŒ¨");
            const auto = localStorage.getItem('game_auto_user');
            if(auto) {
                const users = JSON.parse(localStorage.getItem('game_users') || "{}");
                if(users[auto]) { currentUser = auto; data = users[auto].data; MainEngine.enterGame(); }
            }
        },
        handleLogin: () => {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            if(!id || !pw) return alert("ì •ë³´ ì…ë ¥ í•„ìš”");
            const users = JSON.parse(localStorage.getItem('game_users') || "{}");
            if(users[id]) {
                if(users[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
                data = users[id].data;
            } else {
                data = { level:1, exp:0, gold:10000, hp:100, inventory:[], equipment:{weapon:null, armor:null, belt:null}, potions:0, potionCount:0, mineGrid:[] };
                users[id] = { pw, data };
            }
            currentUser = id;
            if(document.getElementById('auto-login').checked) localStorage.setItem('game_auto_user', id);
            localStorage.setItem('game_users', JSON.stringify(users));
            MainEngine.enterGame();
        },
        enterGame: () => {
            document.getElementById('login-container').style.display='none';
            document.getElementById('game-container').style.display='block';
            MainEngine.updateUI();
        },
        logout: () => { showPage('page-main'); localStorage.removeItem('game_auto_user'); location.reload(); },
        saveGame: () => {
            if(currentUser && data) {
                const users = JSON.parse(localStorage.getItem('game_users') || "{}");
                users[currentUser].data = data;
                localStorage.setItem('game_users', JSON.stringify(users));
            }
        },
        updateUI: () => {
            if(!data) return;
            const stats = MainEngine.getFinalStats();
            
            // [ìˆ˜ì •] ë¬¼ì•½ í‘œì‹œ: ì´ íšŒë³µëŸ‰(potions)ê³¼ ë³´ìœ  ê°œìˆ˜(potionCount) ë™ì‹œ í‘œê¸°
            document.getElementById('gold').innerText = Math.floor(data.gold).toLocaleString();
            document.getElementById('potion-val').innerText = (data.potions || 0).toLocaleString();
            document.getElementById('potion-cnt').innerText = (data.potionCount || 0);

            // HPë°”
            document.getElementById('hp-val').innerText = Math.max(0, Math.floor(data.hp)).toLocaleString();
            document.getElementById('hp-max').innerText = Math.floor(stats.hp).toLocaleString();
            document.getElementById('hp-fill').style.width = ((data.hp / stats.hp * 100) || 0) + '%';
            
            // [ìˆ˜ì •] ê²½í—˜ì¹˜ í…ìŠ¤íŠ¸ í‘œì‹œ
            const nextExp = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
            const expPer = ((data.exp / nextExp * 100) || 0).toFixed(1);
            document.getElementById('exp-fill').style.width = expPer + '%';
            document.getElementById('user-lv').innerText = data.level;
            document.getElementById('exp-text').innerText = `${Math.floor(data.exp).toLocaleString()} / ${Math.floor(nextExp).toLocaleString()} (${expPer}%)`;
            
            const infoAtk = document.getElementById('info-atk');
            if(infoAtk) {
                infoAtk.innerText = Math.floor(stats.atk).toLocaleString();
                document.getElementById('info-def').innerText = Math.floor(stats.def).toLocaleString();
                document.getElementById('info-hp').innerText = Math.floor(stats.hp).toLocaleString();
            }
            MainEngine.renderInventory();
            MainEngine.saveGame();
        },
        getFinalStats: () => {
            if(typeof GameDatabase === 'undefined') return { atk:10, def:2, hp:100 };
            let bAtk = GameDatabase.USER_STATS.CALC_ATK(data.level);
            let bDef = GameDatabase.USER_STATS.CALC_DEF(data.level);
            let bHP = GameDatabase.USER_STATS.CALC_HP(data.level);
            let fAtk = bAtk, fDef = bDef, fHP = bHP;
            const eq = data.equipment;
            if(eq.weapon) fAtk = GameDatabase.ENHANCE_FORMULA.weapon(bAtk, eq.weapon.k, eq.weapon.en);
            if(eq.armor)  fDef = GameDatabase.ENHANCE_FORMULA.armor(bDef, eq.armor.k, eq.armor.en);
            if(eq.belt)   fHP  = GameDatabase.ENHANCE_FORMULA.belt(bHP, eq.belt.k, eq.belt.en);
            return { atk: fAtk, def: fDef, hp: fHP };
        },
        renderInventory: () => {
            const list = document.getElementById('inventory-list');
            if(!list) return;
            list.innerHTML = '';
            data.inventory.forEach((it, idx) => {
                const isEquipped = (data.equipment[it.type] && data.equipment[it.type].id === it.id);
                const div = document.createElement('div'); div.className = 'item-card';
                const imgTag = it.img ? `<img src="image/${it.img}" class="item-icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzMzMyIvPjwvc3ZnPg=='">` : '<div class="item-icon">ğŸ“¦</div>';
                div.innerHTML = `
                    ${imgTag}
                    <div style="flex:1;"><strong>${it.name} +${it.en}</strong> ${isEquipped ? '<span style="color:var(--mine)">[E]</span>' : ''}</div>
                    <div style="display:flex; gap:4px;">
                        <button class="item-btn" style="background:var(--money);" onclick="MainEngine.goToUpgrade(${idx})">ê°•í™”</button>
                        <button class="item-btn" style="background:var(--hunt); color:white;" onclick="MainEngine.toggleEquip(${idx})">${isEquipped ? 'í•´ì œ' : 'ì¥ì°©'}</button>
                        <button class="item-btn" style="background:#c0392b; color:white;" onclick="MainEngine.confirmSell(${idx})">íŒë§¤</button>
                    </div>`;
                list.appendChild(div);
            });
        },
        toggleEquip: (idx) => {
            const it = data.inventory[idx];
            if(data.equipment[it.type] && data.equipment[it.type].id === it.id) data.equipment[it.type] = null;
            else data.equipment[it.type] = it;
            if(data.hp > MainEngine.getFinalStats().hp) data.hp = MainEngine.getFinalStats().hp;
            MainEngine.updateUI();
        },
        confirmSell: (idx) => {
            if(confirm("íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const it = data.inventory[idx];
                data.gold += Math.floor(it.p * 0.5);
                if(data.equipment[it.type] && data.equipment[it.type].id === it.id) data.equipment[it.type] = null;
                data.inventory.splice(idx, 1);
                if(upIdx===idx) MainEngine.resetUpgradeUI();
                MainEngine.updateUI();
            }
        },
        goToUpgrade: (idx) => { showPage('page-upgrade'); if(typeof UpgradeSystem !== 'undefined') UpgradeSystem.selectUpgrade(idx); },
        sellFromUpgrade: () => { if(upIdx !== -1) MainEngine.confirmSell(upIdx); },
        fullHeal: () => { data.hp = MainEngine.getFinalStats().hp; MainEngine.updateUI(); alert("íšŒë³µ ì™„ë£Œ!"); },
        openInventoryModal: () => {
            document.getElementById('inv-modal').style.display='block';
            const mList = document.getElementById('modal-item-list'); mList.innerHTML = '';
            data.inventory.forEach((it, idx) => {
                const btn = document.createElement('button'); btn.className='main-menu-btn';
                btn.innerText = `${it.name} +${it.en}`;
                btn.onclick = () => { if(typeof UpgradeSystem !== 'undefined') UpgradeSystem.selectUpgrade(idx); MainEngine.closeModal(); };
                mList.appendChild(btn);
            });
        },
        closeModal: () => document.getElementById('inv-modal').style.display='none',
        resetUpgradeUI: () => {
            document.getElementById('upgrade-target-display').innerText='ì„ íƒí•˜ì„¸ìš”.';
            document.getElementById('btn-up-exec').disabled=true;
            document.getElementById('btn-up-sell').style.display='none';
            document.getElementById('up-chance').innerText='0';
            document.getElementById('up-break').innerText='0';
            upIdx = -1;
        },
        checkLevelUp: () => {
            let next = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
            let lvUp = false;
            while(data.exp >= next) {
                data.exp -= next;
                data.level++;
                next = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
                lvUp = true;
            }
            if(lvUp) { alert(`ì¶•í•˜í•©ë‹ˆë‹¤! Lv.${data.level}`); MainEngine.updateUI(); }
        }
    };

    function showPage(id) {
        if(autoTimer) { clearInterval(autoTimer); autoTimer=null; }
        if(typeof UpgradeSystem !== 'undefined' && UpgradeSystem.stopAuto) UpgradeSystem.stopAuto();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const t = document.getElementById(id); if(t) t.classList.add('active');
        MainEngine.updateUI();
    }
    function addLog(m, c) { const l = document.getElementById('log-container'); if(l) l.innerHTML=`<div style="color:${c}">> ${m}</div>`+l.innerHTML; }
    
    window.onload = MainEngine.init;
</script>
</body>
</html>
