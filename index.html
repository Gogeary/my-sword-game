<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•í™”í•˜ê¸° v2.0</title>
    <style>
        :root { --bg: #1a1a2e; --panel: #16213e; --point: #e94560; --text: #ecf0f1; --money: #f1c40f; --mine: #2ecc71; --hunt: #3498db; --hp: #ff4d4d; --exp: #9b59b6; }
        body { font-family: 'Malgun Gothic', sans-serif; text-align: center; background-color: var(--bg); color: var(--text); padding: 5px; margin: 0; user-select: none; }
        #game-container { background: var(--panel); max-width: 600px; margin: 0 auto; padding: 15px; border-radius: 15px; border: 2px solid var(--point); min-height: 98vh; box-sizing: border-box; position: relative; }
        .page { display: none; } .page.active { display: block; }
        
        /* ìƒë‹¨ ê³ ì • ìŠ¤íƒ¯ë°” */
        .top-bar { background: #0f3460; padding: 10px; border-radius: 12px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85em; border-bottom: 2px solid var(--point); }
        .bar-outer { grid-column: span 2; background: #333; height: 16px; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #000; margin-top: 3px; }
        #hp-fill { background: var(--hp); height: 100%; width: 100%; transition: 0.3s; }
        #exp-fill { background: var(--exp); height: 100%; width: 0%; transition: 0.3s; }
        .bar-text { position: absolute; width: 100%; left: 0; top: 0; font-size: 0.75em; line-height: 16px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* ë©”ë‰´ ë²„íŠ¼ */
        .main-menu-btn { background: #533483; color: white; padding: 18px; margin: 10px 0; font-size: 1.1em; border-radius: 12px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .main-menu-btn:hover { background: var(--point); transform: scale(1.02); }

        /* ì•„ì´í…œ & ì¸ë²¤í† ë¦¬ */
        .item-card { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; text-align: left; border: 1px solid transparent; }
        .equipped { border-color: var(--money); background: rgba(241, 196, 15, 0.1); }
        .item-icon { width: 40px; height: 40px; margin-right: 12px; border-radius: 5px; object-fit: cover; background: #000; }
        .item-btn { width: 65px; padding: 8px; font-size: 0.8em; margin-left: 4px; border-radius: 5px; font-weight: bold; }

        /* ê°•í™” UI */
        #upgrade-target-display { min-height: 80px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; border: 1px dashed #555; }
        .btn-upgrade { background: var(--point); color: white; height: 50px; font-size: 1.1em; margin-bottom: 5px; }
        .btn-upgrade:disabled { background: #555; cursor: not-allowed; }
        #log-container { height: 100px; overflow-y: auto; background: #1a1a2e; border-radius: 8px; padding: 8px; margin: 8px 0; font-size: 0.8em; text-align: left; color: #95a5a6; border: 1px solid #333; }
        
        /* ì „íˆ¬ ë° ê·¸ë¦¬ë“œ */
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 15px 0; }
        .cell { aspect-ratio: 1/1; background: #0f3460; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2em; border: 2px solid #1a1a2e; position: relative; }
        .monster-lv { position: absolute; bottom: 1px; right: 1px; font-size: 0.55em; background: rgba(0,0,0,0.8); padding: 1px 3px; border-radius: 3px; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 1000; }
        .modal-content { position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); background: var(--panel); border: 2px solid var(--point); padding: 15px; border-radius: 12px; width: 90%; max-width: 420px; max-height: 80vh; overflow-y: auto; }

        button { padding: 10px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-nav { background: #444; color: white; margin-top: 5px; }
        .emergency-btn { background: var(--point); color: white; font-size: 0.8em; padding: 4px; border-radius: 4px; display: none; cursor: pointer; margin-top: 5px; grid-column: span 2; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="top-bar">
        <div>ğŸ’° <span id="gold">0</span>G</div>
        <div><img src="image/sword_shard.png" style="width:12px; vertical-align:middle;"> <span id="shards">0</span></div>
        <div class="bar-outer">
            <div id="hp-fill"></div>
            <div class="bar-text">â¤ï¸ HP <span id="hp-val">100</span> / <span id="hp-max">100</span></div>
        </div>
        <div class="bar-outer">
            <div id="exp-fill"></div>
            <div class="bar-text">â­ Lv.<span id="user-lv">1</span> (<span id="exp-val">0</span> / <span id="exp-max">140</span>)</div>
        </div>
        <div id="emergency-btn" class="emergency-btn" onclick="getEmergencyMoney()">ğŸ†˜ ê³¨ë“œ ë¶€ì¡±! ê¸´ê¸‰ êµ¬ì œ (1,000G)</div>
    </div>

    <div id="page-main" class="page active">
        <h1 style="color:var(--money); margin-bottom:15px; font-size:1.5em;">ê°•í™”í•˜ê¸° v2.0</h1>
        <div class="main-menu-btn" onclick="showPage('page-earn')">ğŸ’° ê³¨ë“œ ìˆ˜ê¸‰<br><small>ì‚¬ëƒ¥í„° & ê´‘ì‚°</small></div>
        <div class="main-menu-btn" onclick="showPage('page-upgrade')">ğŸ”¨ ê°•í™” í•˜ê¸°<br><small>ì¥ë¹„ ì„ íƒ ë° ê°•í™”</small></div>
        <div class="main-menu-btn" onclick="showPage('page-info')">ğŸ‘¤ ë‚´ ì •ë³´<br><small>ì¸ë²¤í† ë¦¬ & ìƒì„¸ ìŠ¤í™</small></div>
        <div class="main-menu-btn" style="background:#222;" onclick="showPage('page-shop-select')">ğŸ›’ ìƒì </div>
    </div>

    <div id="page-earn" class="page">
        <h2>ğŸ’° ê³¨ë“œ ìˆ˜ê¸‰</h2>
        <button class="main-menu-btn" style="background:var(--hunt);" onclick="showPage('page-hunt')">âš”ï¸ ì‚¬ëƒ¥í„° ì…ì¥</button>
        <button class="main-menu-btn" style="background:var(--mine); color:black;" onclick="showPage('page-mine-select')">â›ï¸ ê´‘ì‚° ì…ì¥</button>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-info" class="page">
        <h2>ğŸ‘¤ ë‚´ ì •ë³´</h2>
        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:10px; margin-bottom:12px; text-align:left; font-size:0.9em;">
            <p>âš”ï¸ ìµœì¢… ê³µê²©ë ¥: <span id="info-atk" style="color:var(--point);">0</span></p>
            <p>ğŸ›¡ï¸ ìµœì¢… ë°©ì–´ë ¥: <span id="info-def" style="color:var(--hunt);">0</span></p>
            <p>â¤ï¸ ìµœì¢… ì²´ë ¥: <span id="info-hp" style="color:var(--hp);">0</span></p>
        </div>
        <h3>ğŸ’ ì¸ë²¤í† ë¦¬</h3>
        <div id="inventory-list"></div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-upgrade" class="page">
        <h2>ğŸ”¨ ì¥ë¹„ ê°•í™”</h2>
        <div id="upgrade-target-display">
            <span style="opacity:0.6;">ê°•í™”í•  ì¥ë¹„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</span>
        </div>
        <button onclick="openInventoryModal()" style="background:var(--hunt); margin-bottom:10px; font-size:0.9em;">ğŸ“¦ ì¸ë²¤í† ë¦¬ ì—´ê¸°</button>

        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; margin-bottom:8px; text-align:left; font-size:0.8em;">
            <h4 style="margin:0 0 5px 0; color:var(--money);">ğŸ›¡ï¸ ë°©ì§€ê¶Œ ì„ íƒ</h4>
            <label><input type="radio" name="prot" value="0" checked> ë¯¸ì‚¬ìš©</label>
            <label><input type="radio" name="prot" value="1"> í•˜ê¸‰(<span id="inv-1">0</span>)</label>
            <label><input type="radio" name="prot" value="2"> ì¤‘ê¸‰(<span id="inv-2">0</span>)</label>
            <label><input type="radio" name="prot" value="3"> ìƒê¸‰(<span id="inv-3">0</span>)</label>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9em; font-weight:bold;">
            <span style="color:#4ecca3;">ì„±ê³µ <span id="up-chance">0</span>%</span>
            <span style="color:var(--point);">íŒŒê´´ <span id="up-break">0</span>%</span>
        </div>
        <button class="btn-upgrade" id="btn-up-exec" onclick="tryUpgrade()" disabled>ê°•í™”í•˜ê¸° (0G)</button>
        <button class="btn-nav" style="background:#3498db; margin-bottom: 5px;" id="auto-btn" onclick="startAutoUpgrade()">ìë™ ê°•í™” (+10ê°•)</button>
        <div id="log-container">ì‹œìŠ¤í…œ: ì¤€ë¹„ ì™„ë£Œ.</div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="page-shop-select" class="page">
        <h2>ğŸ›’ ìƒì </h2>
        <button class="main-menu-btn" style="background:#d35400;" onclick="openShop('equip')">âš”ï¸ ì¥ë¹„ ìƒì </button>
        <button class="main-menu-btn" style="background:#27ae60;" onclick="openShop('item')">ğŸ“œ ì†Œë¹„ ìƒì </button>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>
    <div id="page-shop-detail" class="page">
        <h2 id="shop-title">ìƒì </h2>
        <div id="shop-list"></div>
        <button class="btn-nav" onclick="showPage('page-shop-select')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-hunt" class="page">
        <h2 style="color:var(--hunt);">âš”ï¸ ì‚¬ëƒ¥í„°</h2>
        <div id="hunt-main">
            <button onclick="scanHunt()" style="background:var(--hunt); color:white; margin-bottom:10px;">ğŸ“¡ ëª¬ìŠ¤í„° íƒìƒ‰ (5,000G)</button>
            <div id="hunt-grid" class="grid-5"></div>
            <div id="hunt-log" style="height: 120px; overflow-y: auto; background: #111; border-radius: 8px; padding: 10px; font-size: 0.8em; text-align: left; margin-top: 10px; color: #ccc;">ì „íˆ¬ ëŒ€ê¸° ì¤‘...</div>
            <button class="btn-nav" onclick="showPage('page-earn')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
        </div>
        </div>

    <div id="page-mine-select" class="page">
        <h2>â›ï¸ ê´‘ì‚° ì„ íƒ</h2>
        <div class="main-menu-btn" style="background:#7f8c8d;" onclick="enterMine(1)">1. ê³ ê°ˆëœ ê´‘ì‚° (1,000G)<br><small>ğŸª¨ 40%, ğŸ¥‰ 20%</small></div>
        <div class="main-menu-btn" style="background:#95a5a6;" onclick="enterMine(2)">2. ë¬´ë„ˆì§„ ê´‘ì‚° (10,000G)<br><small>ğŸª¨ 20%, ğŸ¥‰ 30%, ğŸ¥ˆ 10%</small></div>
        <div class="main-menu-btn" style="background:var(--mine); color:black;" onclick="enterMine(3)">3. ë¹›ë‚˜ëŠ” ê´‘ì‚° (100,000G)<br><small>ğŸª¨ 10%, ğŸ¥‰ 20%, ğŸ¥ˆ 25%, ğŸ¥‡ 5%</small></div>
        <div class="main-menu-btn" style="background:#f1c40f; color:black;" onclick="enterMine(4)">4. ì°¬ë€í•œ ê´‘ì‚° (500,000G)<br><small>ğŸ¥ˆ 20%, ğŸ¥‡ 15%, ğŸ’ 1%</small></div>
        <button class="btn-nav" onclick="showPage('page-earn')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-mine-play" class="page">
        <h2 id="mine-title">â›ï¸ ê´‘ë§¥ ì±„êµ´</h2>
        <div id="mine-grid" class="grid-5" style="grid-template-columns: repeat(4, 1fr);"></div>
        <button id="mine-refresh-btn" onclick="refreshMine()" style="background:var(--mine); color:black; display:none;">ìƒˆë¡œìš´ ê´‘ë§¥ íƒìƒ‰</button>
        <button class="btn-nav" onclick="showPage('page-mine-select')">â¬…ï¸ ê´‘ì‚° ë‚˜ê°€ê¸°</button>
    </div>

    <div id="inv-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--money);">ğŸ“¦ ì¥ë¹„ ì„ íƒ</h3>
            <div id="modal-item-list"></div>
            <button class="btn-nav" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    /* [v2.0 ë°ì´í„° êµ¬ì¡° - ì´ˆê¸° ìê¸ˆ 10,000G] */
    const SAVE_KEY = 'swordRPG_v2_0'; 
    let data = {
        level: 1, exp: 0, gold: 10000, shards: 0, hp: 100,
        equipment: { weapon: null, armor: null, belt: null },
        inventory: [],
        invScrolls: { item1: 0, item2: 0, item3: 0 },
        currentMine: null, mineGrid: []
    };

    let isAuto = false;
    let upTargetIdx = -1;

    /* [ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ ê³µì‹] */
    const getBaseAtk = lv => 10 + 0.5 * Math.pow(lv - 1, 1.2);
    const getBaseDef = lv => 2 + 0.1 * Math.pow(lv - 1, 1.1);
    const getBaseHP = lv => 100 + 5 * Math.pow(lv - 1, 1.3);
    const getNextExp = lv => lv * 100 * 1.4;

    /* [ì¥ë¹„ ì•„ì´í…œ ë°ì´í„°] */
    const ITEM_DB = [
        { lv:1, type:'weapon', name:'ë‚˜ë¬´ ê²€', k:1.1, p:1000, img:'image/wood_sword.png' },
        { lv:1, type:'armor', name:'í—ê±°ìš´ ì˜·', k:1.0, p:1000, img:'image/loose_clothes.png' },
        { lv:1, type:'belt', name:'ë‚¡ì€ ë²¨íŠ¸', k:1.0, p:1000, img:'image/old_belt.png' },
        { lv:5, type:'weapon', name:'ë‚¡ì€ ê²€', k:1.2, p:10000 },
        { lv:5, type:'armor', name:'ì²œ ì˜·', k:1.1, p:10000 },
        { lv:5, type:'belt', name:'ì²œ ë²¨íŠ¸', k:1.2, p:10000 },
        { lv:10, type:'weapon', name:'ì²  ê²€', k:1.4, p:100000 },
        { lv:10, type:'armor', name:'ì§ˆê¸´ ì˜·', k:1.3, p:100000 },
        { lv:10, type:'belt', name:'ì§ˆê¸´ ë²¨íŠ¸', k:1.5, p:100000 },
        { lv:15, type:'weapon', name:'ê°•ì²  ê²€', k:1.7, p:500000 },
        { lv:15, type:'armor', name:'ê°€ì£½ ì˜·', k:1.6, p:500000 },
        { lv:15, type:'belt', name:'ê°€ì£½ ë²¨íŠ¸', k:1.9, p:500000 },
        { lv:20, type:'weapon', name:'ì—°ë§ˆëœ ê°•ì²  ê²€', k:2.1, p:1500000 },
        { lv:20, type:'armor', name:'ê°•í™” ê°€ì£½ ì˜·', k:2.0, p:1500000 },
        { lv:20, type:'belt', name:'ê°•í™” ê°€ì£½ ë²¨íŠ¸', k:2.5, p:1500000 },
        { lv:25, type:'weapon', name:'ì€ë¹› ê°•ì²  ê²€', k:2.7, p:3500000 },
        { lv:25, type:'armor', name:'ë¹„ëŠ˜ ê°‘ì˜·', k:2.5, p:3500000 },
        { lv:25, type:'belt', name:'ê¸ˆì† ì¥ì‹ ë²¨íŠ¸', k:3.3, p:3500000 },
        { lv:30, type:'weapon', name:'ì€ ê²€', k:3.5, p:8000000 },
        { lv:30, type:'armor', name:'ê°•ì²  ê°‘ì˜·', k:3.2, p:8000000 },
        { lv:30, type:'belt', name:'ìš©ë³‘ ë²¨íŠ¸', k:4.5, p:8000000 }
    ];

    /* [ìµœì¢… ìŠ¤íƒ¯ ê³„ì‚°] */
    function getFinalStats() {
        let atk = getBaseAtk(data.level);
        let def = getBaseDef(data.level);
        let hp = getBaseHP(data.level);

        const w = data.equipment.weapon;
        const a = data.equipment.armor;
        const b = data.equipment.belt;

        if(w) atk = getBaseAtk(data.level) * w.k * (1 + 0.2 * Math.pow(w.en, 1.1));
        if(a) def = getBaseDef(data.level) * a.k * (1 + 0.5 * a.en);
        if(b) hp = getBaseHP(data.level) * b.k * (1 + 0.1 * Math.pow(b.en, 1.25));

        return { atk, def, hp };
    }

    function updateUI() {
        const stats = getFinalStats();
        document.getElementById('gold').innerText = Math.floor(data.gold).toLocaleString();
        document.getElementById('shards').innerText = data.shards;
        document.getElementById('hp-val').innerText = Math.floor(data.hp);
        document.getElementById('hp-max').innerText = Math.floor(stats.hp);
        document.getElementById('hp-fill').style.width = (data.hp / stats.hp * 100) + '%';
        
        document.getElementById('user-lv').innerText = data.level;
        document.getElementById('exp-val').innerText = Math.floor(data.exp);
        const nextExp = getNextExp(data.level);
        document.getElementById('exp-max').innerText = Math.floor(nextExp);
        document.getElementById('exp-fill').style.width = (data.exp / nextExp * 100) + '%';

        document.getElementById('info-atk').innerText = Math.floor(stats.atk).toLocaleString();
        document.getElementById('info-def').innerText = Math.floor(stats.def).toLocaleString();
        document.getElementById('info-hp').innerText = Math.floor(stats.hp).toLocaleString();

        document.getElementById('inv-1').innerText = data.invScrolls.item1;
        document.getElementById('inv-2').innerText = data.invScrolls.item2;
        document.getElementById('inv-3').innerText = data.invScrolls.item3;

        document.getElementById('emergency-btn').style.display = (data.gold < 1000 && !data.equipment.weapon && !data.equipment.armor && !data.equipment.belt) ? 'block' : 'none';
        renderInventory();
    }

    /* [ì¸ë²¤í† ë¦¬ ë° ì•„ì´í…œ ê´€ë¦¬] */
    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = "";
        data.inventory.forEach((item, idx) => {
            const isEquipped = (data.equipment[item.type] && data.equipment[item.type].id === item.id);
            const card = document.createElement('div');
            card.className = `item-card ${isEquipped ? 'equipped' : ''}`;
            card.innerHTML = `
                <div class="item-info">
                    <img src="${item.img || 'https://placehold.co/40x40/000/fff?text=?'}" class="item-icon">
                    <div><strong>${item.name} +${item.en}</strong><br><small>Lv.${item.lv} ${item.type}</small></div>
                </div>
                <div>
                    <button class="item-btn" style="background:#2ecc71;" onclick="equipItem(${idx})">${isEquipped ? 'í•´ì œ' : 'ì¥ì°©'}</button>
                    <button class="item-btn" style="background:#3498db;" onclick="selectUpgrade(${idx})">ê°•í™”</button>
                </div>`;
            list.appendChild(card);
        });
    }

    function equipItem(idx) {
        const item = data.inventory[idx];
        if(data.equipment[item.type] && data.equipment[item.type].id === item.id) {
            data.equipment[item.type] = null;
        } else {
            data.equipment[item.type] = item;
        }
        save();
    }

    function selectUpgrade(idx) {
        upTargetIdx = idx;
        const item = data.inventory[idx];
        document.getElementById('upgrade-target-display').innerHTML = `
            <div class="item-card" style="width:100%; border:none; background:none;">
                <img src="${item.img || 'https://placehold.co/40x40/000/fff?text=?'}" class="item-icon">
                <div><strong>${item.name} +${item.en}</strong></div>
                <button class="item-btn" style="background:var(--mine); color:black;" onclick="sellFromUpgrade()">íŒë§¤</button>
            </div>`;
        
        const cost = Math.floor(item.p * 0.5 * Math.pow(1.5, item.en));
        const btn = document.getElementById('btn-up-exec');
        btn.innerText = `ê°•í™”í•˜ê¸° (${cost.toLocaleString()}G)`;
        btn.disabled = false;

        const sc = item.en < 3 ? 100 : item.en < 6 ? 85 : item.en < 9 ? 60 : 40;
        const bc = item.en >= 10 ? Math.min(50, 5 + (item.en - 10) * 5) : 0;
        document.getElementById('up-chance').innerText = sc;
        document.getElementById('up-break').innerText = bc;
        showPage('page-upgrade');
    }

    function sellFromUpgrade() {
        if(upTargetIdx === -1) return;
        const item = data.inventory[upTargetIdx];
        const sp = Math.floor(item.p * 0.4 * Math.pow(1.2, item.en));
        data.gold += sp;
        if(data.equipment[item.type] && data.equipment[item.type].id === item.id) data.equipment[item.type] = null;
        data.inventory.splice(upTargetIdx, 1);
        upTargetIdx = -1;
        document.getElementById('upgrade-target-display').innerHTML = "íŒë§¤ ì™„ë£Œ.";
        document.getElementById('btn-up-exec').disabled = true;
        save();
    }

    function tryUpgrade() {
        if(upTargetIdx === -1) return;
        const item = data.inventory[upTargetIdx];
        const cost = Math.floor(item.p * 0.5 * Math.pow(1.5, item.en));
        
        if(data.gold < cost) { isAuto = false; alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }

        const sel = document.querySelector('input[name="prot"]:checked').value;
        if(sel !== "0") {
            if(data.invScrolls[`item${sel}`] > 0) data.invScrolls[`item${sel}`]--;
            else { isAuto = false; alert("ë°©ì§€ê¶Œ ë¶€ì¡±!"); return; }
        }

        data.gold -= cost;
        const sc = item.en < 3 ? 100 : item.en < 6 ? 85 : item.en < 9 ? 60 : 40;
        const bc = item.en >= 10 ? Math.min(50, 5 + (item.en - 10) * 5) : 0;

        if(Math.random()*100 < sc) {
            item.en++; addLog(`+${item.en} ì„±ê³µ!`, "#4ecca3");
        } else {
            if(Math.random()*100 < bc && sel !== "3") {
                if(data.equipment[item.type] && data.equipment[item.type].id === item.id) data.equipment[item.type] = null;
                data.inventory.splice(upTargetIdx, 1);
                data.shards++; addLog("ì¥ë¹„ íŒŒê´´!", "red");
                upTargetIdx = -1; isAuto = false;
                document.getElementById('upgrade-target-display').innerHTML = "íŒŒê´´ë¨";
                document.getElementById('btn-up-exec').disabled = true;
            } else {
                item.en = Math.max(0, item.en - 1); addLog("ì‹¤íŒ¨(í•˜ë½)");
            }
        }
        save();
        if(upTargetIdx !== -1) selectUpgrade(upTargetIdx);
    }

    /* [ì „íˆ¬ ì‹œìŠ¤í…œ] */
    const MON_DB = [
        { lv:1, hp:280, atk:25, def:5, g:100 },
        { lv:5, hp:380, atk:35, def:8, g:1000 },
        { lv:10, hp:650, atk:55, def:15, g:7000 },
        { lv:15, hp:1200, atk:95, def:30, g:10000 },
        { lv:20, hp:2200, atk:160, def:55, g:15000 },
        { lv:25, hp:4200, atk:300, def:100, g:30000 },
        { lv:30, hp:7500, atk:550, def:180, g:50000 }
    ];

    function getMonStats(lv) {
        let low = MON_DB[0], high = MON_DB[MON_DB.length-1];
        for(let i=0; i<MON_DB.length-1; i++) {
            if(lv >= MON_DB[i].lv && lv <= MON_DB[i+1].lv) {
                low = MON_DB[i]; high = MON_DB[i+1]; break;
            }
        }
        const ratio = (lv - low.lv) / (high.lv - low.lv || 1);
        const lerp = (a, b) => a + (b - a) * ratio;
        return {
            lv, hp: lerp(low.hp, high.hp), atk: lerp(low.atk, high.atk),
            def: lerp(low.def, high.def), g: lerp(low.g, high.g)
        };
    }

    function scanHunt() {
        if(data.gold < 5000) return alert("ê³¨ë“œ ë¶€ì¡±!");
        data.gold -= 5000;
        const g = document.getElementById('hunt-grid'); g.innerHTML = "";
        for(let i=0; i<5; i++) {
            const lv = Math.max(1, data.level + Math.floor(Math.random()*11) - 5);
            const m = getMonStats(lv);
            const cell = document.createElement('div'); cell.className = "cell";
            cell.innerHTML = `ğŸ‘¾<span class="monster-lv">Lv.${lv}</span>`;
            cell.onclick = () => startBattle(m);
            g.appendChild(cell);
        }
        save();
    }

    function startBattle(m) {
        if(data.hp <= 0) return alert("ì²´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤!");
        document.getElementById('hunt-grid').style.pointerEvents = 'none';
        const log = document.getElementById('hunt-log');
        log.innerHTML = `Lv.${m.lv} ëª¬ìŠ¤í„°ì™€ ì¡°ìš°!<br>`;
        
        let pStats = getFinalStats();
        let mHP = m.hp;
        
        const bItv = setInterval(() => {
            // [ë°©ì–´ë ¥ ì‹œìŠ¤í…œ ì ìš© ëŒ€ë¯¸ì§€ ê³µì‹]
            const calcDmg = (atk, def) => atk >= def ? (atk * 2 - def) : (Math.pow(atk, 2) / def);
            
            // ë‚´ í„´
            let pDmg = Math.floor(calcDmg(pStats.atk, m.def));
            mHP -= pDmg;
            log.innerHTML = `ë‚´ê°€ ${pDmg} ë°ë¯¸ì§€! (ëª¬ìŠ¤í„° HP: ${Math.max(0, Math.floor(mHP))})<br>` + log.innerHTML;

            if(mHP <= 0) {
                clearInterval(bItv);
                data.gold += m.g;
                const earnedExp = m.lv * 20;
                data.exp += earnedExp;
                log.innerHTML = `<span style="color:var(--mine)">ìŠ¹ë¦¬! ${Math.floor(m.g)}Gì™€ ${earnedExp} Exp íšë“!</span><br>` + log.innerHTML;
                checkLevelUp();
                document.getElementById('hunt-grid').style.pointerEvents = 'auto';
                save(); return;
            }

            // ëª¬ìŠ¤í„° í„´
            let mDmg = Math.floor(calcDmg(m.atk, pStats.def));
            data.hp -= mDmg;
            log.innerHTML = `<span style="color:var(--hp)">ëª¬ìŠ¤í„°ê°€ ${mDmg} ë°ë¯¸ì§€!</span><br>` + log.innerHTML;

            if(data.hp <= 0) {
                clearInterval(bItv);
                data.hp = 0;
                log.innerHTML = `<span style="color:red">íŒ¨ë°°... ë§ˆì„ë¡œ ë„ë§ì³¤ìŠµë‹ˆë‹¤.</span><br>` + log.innerHTML;
                document.getElementById('hunt-grid').style.pointerEvents = 'auto';
                save();
            }
        }, 100);
    }

    function checkLevelUp() {
        while(data.exp >= getNextExp(data.level)) {
            data.exp -= getNextExp(data.level);
            data.level++;
            addLog(`â­ ë ˆë²¨ì—…! Lv.${data.level} ë‹¬ì„±!`, "var(--exp)");
        }
    }

    /* [ê´‘ì‚° ì‹œìŠ¤í…œ ê°œí¸] */
    const MINE_SETTINGS = {
        1: { p:1000, rates: { empty:0.4, stone:0.4, copper:0.2, silver:0, gold:0, dia:0 } },
        2: { p:10000, rates: { empty:0.4, stone:0.2, copper:0.3, silver:0.1, gold:0, dia:0 } },
        3: { p:100000, rates: { empty:0.4, stone:0.1, copper:0.2, silver:0.25, gold:0.05, dia:0 } },
        4: { p:500000, rates: { empty:0.39, stone:0.1, copper:0.15, silver:0.2, gold:0.15, dia:0.01 } }
    };
    const ORE_VAL = { stone:1000, copper:2000, silver:20000, gold:100000, dia:2000000 };
    const ORE_IMG = { stone:"ğŸª¨", copper:"ğŸ¥‰", silver:"ğŸ¥ˆ", gold:"ğŸ¥‡", dia:"ğŸ’" };

    function enterMine(tier) {
        const s = MINE_SETTINGS[tier];
        if(data.gold < s.p) return alert("ê³¨ë“œ ë¶€ì¡±!");
        data.gold -= s.p;
        data.currentMine = tier;
        generateMineGrid(s.rates);
        showPage('page-mine-play');
        save();
    }

    function generateMineGrid(rates) {
        data.mineGrid = [];
        for(let i=0; i<16; i++) {
            const r = Math.random();
            let acc = 0, type = null;
            for(let k in rates) {
                acc += rates[k];
                if(r <= acc) { type = k; break; }
            }
            data.mineGrid.push(type === 'empty' ? null : { type, val: ORE_VAL[type], img: ORE_IMG[type] });
        }
        renderMine();
    }

    function renderMine() {
        const g = document.getElementById('mine-grid'); g.innerHTML = "";
        let hasOre = false;
        data.mineGrid.forEach((ore, i) => {
            const cell = document.createElement('div'); cell.className = "cell";
            if(ore) {
                cell.innerText = ore.img;
                cell.onclick = () => collectOre(i);
                hasOre = true;
            }
            g.appendChild(cell);
        });
        document.getElementById('mine-refresh-btn').style.display = hasOre ? 'none' : 'block';
    }

    function collectOre(i) {
        data.gold += data.mineGrid[i].val;
        data.mineGrid[i] = null;
        renderMine();
        save();
    }

    function refreshMine() {
        const s = MINE_SETTINGS[data.currentMine];
        if(data.gold < s.p) return alert("ê³¨ë“œ ë¶€ì¡±!");
        data.gold -= s.p;
        generateMineGrid(s.rates);
        save();
    }

    /* [ìƒì  ì‹œìŠ¤í…œ] */
    function openShop(cat) {
        showPage('page-shop-detail');
        const list = document.getElementById('shop-list'); list.innerHTML = "";
        if(cat === 'equip') {
            document.getElementById('shop-title').innerText = "âš”ï¸ ì¥ë¹„ ìƒì ";
            ITEM_DB.forEach(item => {
                const card = document.createElement('div'); card.className = "item-card";
                card.innerHTML = `
                    <div class="item-info">
                        <img src="${item.img || 'https://placehold.co/40x40/000/fff?text=?'}" class="item-icon">
                        <div><strong>${item.name}</strong><br><small>Lv.${item.lv} ${item.p.toLocaleString()}G</small></div>
                    </div>
                    <button class="item-btn" style="background:var(--money); color:black;" onclick="buyEquip(${JSON.stringify(item).replace(/"/g, '&quot;')})">êµ¬ë§¤</button>`;
                list.appendChild(card);
            });
        } else {
            document.getElementById('shop-title').innerText = "ğŸ“œ ì†Œë¹„ ìƒì ";
            const items = [{t:1, n:"í•˜ê¸‰ ë°©ì§€ê¶Œ", p:100000, img:"image/scroll_1.png"}, {t:2, n:"ì¤‘ê¸‰ ë°©ì§€ê¶Œ", p:500000, img:"image/scroll_2.png"}, {t:3, n:"ìƒê¸‰ ë°©ì§€ê¶Œ", p:2000000, img:"image/scroll_3.png"}];
            items.forEach(it => {
                const card = document.createElement('div'); card.className = "item-card";
                card.innerHTML = `<div class="item-info"><img src="${it.img}" class="item-icon"><div><strong>${it.n}</strong><br><small>${it.p.toLocaleString()}G</small></div></div><button class="item-btn" style="background:var(--money); color:black;" onclick="buyScroll(${it.t}, ${it.p})">êµ¬ë§¤</button>`;
                list.appendChild(card);
            });
        }
    }

    function buyEquip(proto) {
        if(data.gold < proto.p) return alert("ê³¨ë“œ ë¶€ì¡±!");
        data.gold -= proto.p;
        data.inventory.push({ ...proto, en: 0, id: Date.now() + Math.random() });
        alert(`${proto.name} êµ¬ë§¤ ì™„ë£Œ!`);
        save();
    }

    function buyScroll(t, p) {
        if(data.gold < p) return alert("ê³¨ë“œ ë¶€ì¡±!");
        data.gold -= p; data.invScrolls[`item${t}`]++; save();
    }

    /* [ê³µí†µ ë¡œì§] */
    function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); updateUI(); }
    function addLog(m, c) { const l = document.getElementById('log-container'); l.innerHTML = `<div style="color:${c || '#95a5a6'}">> ${m}</div>` + l.innerHTML; }
    function openInventoryModal() { document.getElementById('inv-modal').style.display = 'block'; renderModalInventory(); }
    function closeModal() { document.getElementById('inv-modal').style.display = 'none'; }
    function getEmergencyMoney() { data.gold += 1000; alert("êµ¬ì œê¸ˆ 1,000G ì§€ê¸‰ ì™„ë£Œ!"); save(); }
    function save() { localStorage.setItem(SAVE_KEY, JSON.stringify(data)); updateUI(); }
    function load() { const s = localStorage.getItem(SAVE_KEY); if(s) data = JSON.parse(s); updateUI(); }
    function renderModalInventory() {
        const list = document.getElementById('modal-item-list'); list.innerHTML = "";
        data.inventory.forEach((item, idx) => {
            const card = document.createElement('div'); card.className = "item-card";
            card.innerHTML = `<div class="item-info"><img src="${item.img || 'https://placehold.co/40x40/000/fff?text=?'}" class="item-icon"><div><strong>${item.name} +${item.en}</strong></div></div><button class="item-btn" style="background:var(--hunt);" onclick="confirmSelect(${idx})">ì„ íƒ</button>`;
            list.appendChild(card);
        });
    }
    function confirmSelect(idx) { closeModal(); selectUpgrade(idx); }
    function startAutoUpgrade() {
        if(isAuto) { isAuto=false; return; }
        if(upTargetIdx === -1) return;
        isAuto = true;
        const itv = setInterval(() => {
            if(!isAuto || upTargetIdx === -1 || data.inventory[upTargetIdx].en >= 10) { clearInterval(itv); isAuto=false; updateUI(); return; }
            tryUpgrade();
        }, 100);
    }
    setInterval(() => { if(data.hp < getFinalStats().hp) { data.hp = Math.min(getFinalStats().hp, data.hp + 1); updateUI(); } }, 2000);
    load();
</script>
</body>
</html>
