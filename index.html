/* ==========================================
   [MainEngine í†µí•© ì œì–´]
   ========================================== */
let currentUser = null, data = null, upIdx = -1, autoTimer = null;

const MainEngine = {
    init: () => {
        try {
            const auto = localStorage.getItem('game_auto_user');
            if(auto) {
                const users = JSON.parse(localStorage.getItem('game_users') || "{}");
                if(users[auto]) { 
                    currentUser = auto; 
                    data = users[auto].data; 
                    MainEngine.enterGame(); 
                }
            }
        } catch (e) {
            console.error("ì´ˆê¸°í™” ì—ëŸ¬:", e);
            localStorage.clear(); // ì—ëŸ¬ ë°œìƒ ì‹œ ë°ì´í„° ì´ˆê¸°í™” í›„ ìƒˆë¡œê³ ì¹¨
        }
    },

    handleLogin: () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        if(!id || !pw) return alert("ì •ë³´ë¥¼ ìž…ë ¥í•˜ì„¸ìš”.");

        const users = JSON.parse(localStorage.getItem('game_users') || "{}");
        if(users[id]) {
            if(users[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
            data = users[id].data;
        } else {
            // ì´ˆê¸° ë°ì´í„° ì„¸íŒ…
            data = { 
                level: 1, exp: 0, gold: 10000, hp: 100, 
                inventory: [], 
                equipment: { weapon: null, armor: null, belt: null }, 
                potions: 0, potionCount: 0, mineGrid: [] 
            };
            users[id] = { pw, data };
        }
        currentUser = id;
        if(document.getElementById('auto-login').checked) localStorage.setItem('game_auto_user', id);
        localStorage.setItem('game_users', JSON.stringify(users));
        MainEngine.enterGame();
    },

    enterGame: () => {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        MainEngine.updateUI();
    },

    saveGame: () => {
        if(currentUser && data) {
            const users = JSON.parse(localStorage.getItem('game_users') || "{}");
            users[currentUser].data = data;
            localStorage.setItem('game_users', JSON.stringify(users));
        }
    },

    updateUI: () => {
        if(!data) return;
        const stats = MainEngine.getFinalStats();
        
        // ìƒë‹¨ ë°” ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('gold').innerText = Math.floor(data.gold).toLocaleString();
        document.getElementById('hp-val').innerText = Math.max(0, Math.floor(data.hp));
        document.getElementById('hp-max').innerText = Math.floor(stats.hp);
        
        // HP ë°” & ê²½í—˜ì¹˜ ë°” (NaN ë°©ì§€)
        const hpPer = (data.hp / stats.hp * 100) || 0;
        document.getElementById('hp-fill').style.width = hpPer + '%';
        
        const nextExp = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
        const expPer = (data.exp / nextExp * 100) || 0;
        document.getElementById('exp-fill').style.width = expPer + '%';
        document.getElementById('user-lv').innerText = data.level;
        
        // ë‚´ ì •ë³´ ì°½
        const infoAtk = document.getElementById('info-atk');
        if(infoAtk) {
            infoAtk.innerText = Math.floor(stats.atk).toLocaleString();
            document.getElementById('info-def').innerText = Math.floor(stats.def).toLocaleString();
            document.getElementById('info-hp').innerText = Math.floor(stats.hp).toLocaleString();
        }
        
        MainEngine.renderInventory();
        MainEngine.saveGame();
    },

    getFinalStats: () => {
        // Database.js ê°€ ì •ìƒ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (typeof GameDatabase === 'undefined') return { atk: 10, def: 5, hp: 100 };

        let bAtk = GameDatabase.USER_STATS.CALC_ATK(data.level);
        let bDef = GameDatabase.USER_STATS.CALC_DEF(data.level);
        let bHP = GameDatabase.USER_STATS.CALC_HP(data.level);
        
        let fAtk = bAtk, fDef = bDef, fHP = bHP;
        const eq = data.equipment;
        
        if(eq.weapon) fAtk = GameDatabase.ENHANCE_FORMULA.weapon(bAtk, eq.weapon.k, eq.weapon.en);
        if(eq.armor)  fDef = GameDatabase.ENHANCE_FORMULA.armor(bDef, eq.armor.k, eq.armor.en);
        if(eq.belt)   fHP  = GameDatabase.ENHANCE_FORMULA.belt(bHP, eq.belt.k, eq.belt.en);
        
        return { atk: fAtk, def: fDef, hp: fHP };
    },

    checkLevelUp: () => {
        let next = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
        let lvUp = false;
        while(data.exp >= next) {
            data.exp -= next;
            data.level++;
            next = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
            lvUp = true;
        }
        if(lvUp) {
            alert(`Level Up! í˜„ìž¬ ë ˆë²¨: ${data.level}`);
            MainEngine.updateUI();
        }
    },

    renderInventory: () => {
        const list = document.getElementById('inventory-list');
        if(!list) return;
        list.innerHTML = '';
        data.inventory.forEach((it, idx) => {
            const isEquipped = (data.equipment[it.type] && data.equipment[it.type].id === it.id);
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `
                <div class="item-icon">ðŸ“¦</div>
                <div style="flex:1;"><strong>${it.name} +${it.en}</strong> ${isEquipped ? '<span style="color:var(--mine)">[E]</span>' : ''}</div>
                <div style="display:flex; gap:4px;">
                    <button class="item-btn" style="background:var(--money);" onclick="MainEngine.goToUpgrade(${idx})">ê°•í™”</button>
                    <button class="item-btn" style="background:var(--hunt); color:white;" onclick="MainEngine.toggleEquip(${idx})">${isEquipped ? 'í•´ì œ' : 'ìž¥ì°©'}</button>
                </div>`;
            list.appendChild(div);
        });
    },

    goToUpgrade: (idx) => {
        showPage('page-upgrade');
        if (typeof UpgradeSystem !== 'undefined') UpgradeSystem.selectUpgrade(idx);
    },

    toggleEquip: (idx) => {
        const it = data.inventory[idx];
        if(data.equipment[it.type] && data.equipment[it.type].id === it.id) data.equipment[it.type] = null;
        else data.equipment[it.type] = it;
        MainEngine.updateUI();
    }
};

// íŽ˜ì´ì§€ ì „í™˜ ì‹œ ì¸í„°ë²Œ ì²­ì†Œ
function showPage(id) {
    if(autoTimer) { clearInterval(autoTimer); autoTimer = null; }
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const target = document.getElementById(id);
    if(target) target.classList.add('active');
    MainEngine.updateUI();
}

window.onload = MainEngine.init;
