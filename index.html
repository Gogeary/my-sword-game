<script>
    /* ==========================================
       [ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬]
       ========================================== */
    let currentUser = null;
    let data = null;
    let upIdx = -1;
    let autoTimer = null; // ëª¨ë“  ìë™ ë¡œì§(ì „íˆ¬, ê°•í™”)ì—ì„œ ê³µìœ 

    /* ==========================================
       [ë©”ì¸ ì œì–´ ì—”ì§„]
       ========================================== */
    const MainEngine = {
        // ì´ˆê¸° ë¡œë“œ: ìë™ ë¡œê·¸ì¸ í™•ì¸
        init: () => {
            const auto = localStorage.getItem('game_auto_user');
            if(auto) {
                const users = JSON.parse(localStorage.getItem('game_users') || "{}");
                if(users[auto]) { 
                    currentUser = auto; 
                    data = users[auto].data; 
                    MainEngine.enterGame(); 
                }
            }
        },

        // ë¡œê·¸ì¸ ë° ì‹ ê·œ ìƒì„±
        handleLogin: () => {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            if(!id || !pw) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const users = JSON.parse(localStorage.getItem('game_users') || "{}");
            if(users[id]) {
                if(users[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
                data = users[id].data;
            } else {
                // ì‹ ê·œ ìœ ì € ì´ˆê¸° ë°ì´í„° (Database.js ì°¸ì¡° ì „ í™•ì¸)
                data = { 
                    level: 1, exp: 0, gold: 10000, hp: 100, 
                    inventory: [], 
                    equipment: { weapon: null, armor: null, belt: null }, 
                    potions: 0, potionCount: 0, mineGrid: [] 
                };
                users[id] = { pw, data };
            }
            currentUser = id;
            if(document.getElementById('auto-login').checked) localStorage.setItem('game_auto_user', id);
            localStorage.setItem('game_users', JSON.stringify(users));
            MainEngine.enterGame();
        },

        enterGame: () => {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            MainEngine.updateUI();
        },

        logout: () => {
            MainEngine.stopAllIntervals();
            localStorage.removeItem('game_auto_user');
            location.reload();
        },

        saveGame: () => {
            if(currentUser && data) {
                const users = JSON.parse(localStorage.getItem('game_users') || "{}");
                users[currentUser].data = data;
                localStorage.setItem('game_users', JSON.stringify(users));
            }
        },

        // UI í†µí•© ì—…ë°ì´íŠ¸ (ìŠ¤íƒ¯ ê³„ì‚° í¬í•¨)
        updateUI: () => {
            if(!data) return;
            const stats = MainEngine.getFinalStats();
            
            // ìƒë‹¨ ë°” ì—…ë°ì´íŠ¸
            document.getElementById('gold').innerText = Math.floor(data.gold).toLocaleString();
            document.getElementById('hp-val').innerText = Math.floor(data.hp);
            document.getElementById('hp-max').innerText = Math.floor(stats.hp);
            document.getElementById('hp-fill').style.width = (data.hp / stats.hp * 100) + '%';
            document.getElementById('user-lv').innerText = data.level;
            
            // ì •ë³´ì°½ ì—…ë°ì´íŠ¸
            const infoAtk = document.getElementById('info-atk');
            if(infoAtk) {
                infoAtk.innerText = Math.floor(stats.atk).toLocaleString();
                document.getElementById('info-def').innerText = Math.floor(stats.def).toLocaleString();
                document.getElementById('info-hp').innerText = Math.floor(stats.hp).toLocaleString();
            }
            
            MainEngine.renderInventory();
            MainEngine.saveGame();
        },

        // ìŠ¤íƒ¯ ê³„ì‚° ê³µì‹ ì ìš© (Database.js ì°¸ì¡°)
        getFinalStats: () => {
            let bAtk = GameDatabase.USER_STATS.CALC_ATK(data.level);
            let bDef = GameDatabase.USER_STATS.CALC_DEF(data.level);
            let bHP = GameDatabase.USER_STATS.CALC_HP(data.level);
            
            let fAtk = bAtk, fDef = bDef, fHP = bHP;
            const eq = data.equipment;
            
            if(eq.weapon) fAtk = GameDatabase.ENHANCE_FORMULA.weapon(bAtk, eq.weapon.k, eq.weapon.en);
            if(eq.armor)  fDef = GameDatabase.ENHANCE_FORMULA.armor(bDef, eq.armor.k, eq.armor.en);
            if(eq.belt)   fHP  = GameDatabase.ENHANCE_FORMULA.belt(bHP, eq.belt.k, eq.belt.en);
            
            return { atk: fAtk, def: fDef, hp: fHP };
        },

        // ì¸ë²¤í† ë¦¬ ë Œë”ë§ (ì¥ì°©/ê°•í™”/íŒë§¤ ì—°ë™)
        renderInventory: () => {
            const list = document.getElementById('inventory-list');
            if(!list) return;
            list.innerHTML = '';
            
            data.inventory.forEach((it, idx) => {
                const isEquipped = (data.equipment[it.type] && data.equipment[it.type].id === it.id);
                const div = document.createElement('div');
                div.className = 'item-card';
                const img = it.img ? `<img src="image/${it.img}" class="item-icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCI+PHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMzMzIi8+PC9zdmc+'">` : '<div class="item-icon">ğŸ“¦</div>';
                
                div.innerHTML = `
                    ${img}
                    <div style="flex:1;"><strong>${it.name} +${it.en}</strong> ${isEquipped ? '<span style="color:var(--mine)">[ì¥ì°©ì¤‘]</span>' : ''}</div>
                    <div style="display:flex; flex-direction:row; gap:4px; align-items:center;">
                        <button class="item-btn" style="background:var(--money); color:black;" onclick="MainEngine.goToUpgrade(${idx})">ê°•í™”</button>
                        <button class="item-btn" style="background:var(--hunt); color:white;" onclick="MainEngine.toggleEquip(${idx})">${isEquipped ? 'í•´ì œ' : 'ì¥ì°©'}</button>
                        <button class="item-btn" style="background:#c0392b; color:white;" onclick="MainEngine.confirmSell(${idx})">íŒë§¤</button>
                    </div>`;
                list.appendChild(div);
            });
        },

        toggleEquip: (idx) => {
            const it = data.inventory[idx];
            // ê°™ì€ ì•„ì´í…œ í´ë¦­ ì‹œ í•´ì œ, ë‹¤ë¥¸ ì•„ì´í…œ í´ë¦­ ì‹œ êµì²´ì¥ì°©
            if(data.equipment[it.type] && data.equipment[it.type].id === it.id) {
                data.equipment[it.type] = null;
            } else {
                data.equipment[it.type] = it;
            }
            
            // ë²¨íŠ¸ í•´ì œ ë“±ìœ¼ë¡œ ìµœëŒ€ì²´ë ¥ ê°ì†Œ ì‹œ ë³´ì •
            const stats = MainEngine.getFinalStats();
            if(data.hp > stats.hp) data.hp = stats.hp;
            MainEngine.updateUI();
        },

        confirmSell: (idx) => {
            if(confirm("ì •ë§ë¡œ íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const it = data.inventory[idx];
                data.gold += Math.floor(it.p * 0.5);
                
                // ì¥ì°© ì¤‘ì¸ í…œì´ë©´ ì¥ì°© í•´ì œ
                if(data.equipment[it.type] && data.equipment[it.type].id === it.id) {
                    data.equipment[it.type] = null;
                }
                
                data.inventory.splice(idx, 1);
                if(upIdx === idx) { upIdx = -1; MainEngine.resetUpgradeUI(); }
                MainEngine.updateUI();
            }
        },

        // ê°•í™” í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™
        goToUpgrade: (idx) => {
            showPage('page-upgrade');
            UpgradeSystem.selectUpgrade(idx);
        },

        sellFromUpgrade: () => { if(upIdx !== -1) MainEngine.confirmSell(upIdx); },
        fullHeal: () => { data.hp = MainEngine.getFinalStats().hp; MainEngine.updateUI(); alert("ì²´ë ¥ íšŒë³µ ì™„ë£Œ!"); },
        
        // ì¸ë²¤í† ë¦¬ íŒì—… ëª¨ë‹¬
        openInventoryModal: () => {
            document.getElementById('inv-modal').style.display = 'block';
            const mList = document.getElementById('modal-item-list');
            mList.innerHTML = '';
            data.inventory.forEach((it, idx) => {
                const btn = document.createElement('button');
                btn.className = 'main-menu-btn';
                btn.innerText = `${it.name} +${it.en}`;
                btn.onclick = () => { UpgradeSystem.selectUpgrade(idx); MainEngine.closeModal(); };
                mList.appendChild(btn);
            });
        },
        closeModal: () => { document.getElementById('inv-modal').style.display = 'none'; },

        // ê°•í™” UI ì´ˆê¸°í™”
        resetUpgradeUI: () => {
            document.getElementById('upgrade-target-display').innerText = 'ì„ íƒí•˜ì„¸ìš”.';
            document.getElementById('btn-up-exec').disabled = true;
            document.getElementById('btn-up-sell').style.display = 'none';
            document.getElementById('up-chance').innerText = '0';
            document.getElementById('up-break').innerText = '0';
        },

        // ë ˆë²¨ì—… ì²´í¬
        checkLevelUp: () => { 
            let next = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
            while(data.exp >= next) {
                data.exp -= next;
                data.level++;
                next = GameDatabase.USER_STATS.GET_NEXT_EXP(data.level);
                alert(`ì¶•í•˜í•©ë‹ˆë‹¤! Lv.${data.level}ë¡œ ë ˆë²¨ì—… í•˜ì…¨ìŠµë‹ˆë‹¤!`);
            }
            MainEngine.updateUI();
        },

        // í˜ì´ì§€ ì´ë™ ì‹œ ëª¨ë“  ì¸í„°ë²Œ ì¤‘ì§€ (ì•ˆì „ ì¥ì¹˜)
        stopAllIntervals: () => {
            if(autoTimer) {
                clearInterval(autoTimer);
                autoTimer = null;
            }
            // ê°•í™” ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
            const autoBtn = document.getElementById('auto-btn');
            if(autoBtn) autoBtn.innerText = 'ìë™ ê°•í™” ì‹œì‘';
        }
    };

    /* ==========================================
       [ê³µí†µ ì „ì—­ í•¨ìˆ˜]
       ========================================== */
    function showPage(id) {
        // í˜ì´ì§€ ì´ë™ ì‹œ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì‘ì—…(ìë™ê°•í™”, ì „íˆ¬) ì¤‘ì§€
        MainEngine.stopAllIntervals();
        
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active');
        
        MainEngine.updateUI();
    }

    function addLog(m, c) {
        const l = document.getElementById('log-container');
        if(!l) return;
        l.innerHTML = `<div style="color:${c}">> ${m}</div>` + l.innerHTML;
    }
    
    // ê²Œì„ ì‹œì‘
    window.onload = MainEngine.init;
</script>
