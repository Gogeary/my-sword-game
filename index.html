<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°•í™”í•˜ê¸° v1.1</title>
    <style>
        :root { --bg: #1a1a2e; --panel: #16213e; --point: #e94560; --text: #ecf0f1; --money: #f1c40f; --mine: #2ecc71; --hunt: #3498db; --hp: #ff4d4d; --exp: #9b59b6; }
        body { font-family: 'Malgun Gothic', sans-serif; text-align: center; background-color: var(--bg); color: var(--text); padding: 5px; margin: 0; user-select: none; }
        #game-container { background: var(--panel); max-width: 600px; margin: 0 auto; padding: 15px; border-radius: 15px; border: 2px solid var(--point); min-height: 98vh; box-sizing: border-box; position: relative; display: none; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-container { max-width: 400px; margin: 100px auto; padding: 30px; background: var(--panel); border: 2px solid var(--point); border-radius: 15px; }
        .login-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #0f3460; color: white; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; background: var(--point); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .auto-login-wrap { margin-top: 10px; font-size: 0.9em; color: #aaa; text-align: left; display: flex; align-items: center; }
        .auto-login-wrap input { margin-right: 8px; cursor: pointer; }

        .page { display: none; } .page.active { display: block; }
        
        /* ìƒë‹¨ ë°” */
        .top-bar { background: #0f3460; padding: 10px; border-radius: 12px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.85em; border-bottom: 2px solid var(--point); }
        .bar-outer { grid-column: span 2; background: #333; height: 16px; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #000; margin-top: 3px; }
        #hp-fill { background: var(--hp); height: 100%; width: 100%; transition: 0.3s; }
        #exp-fill { background: var(--exp); height: 100%; width: 0%; transition: 0.3s; }
        .bar-text { position: absolute; width: 100%; left: 0; top: 0; font-size: 0.75em; line-height: 16px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; }

        /* ë²„íŠ¼ ë° ì¹´ë“œ */
        .main-menu-btn { background: #533483; color: white; padding: 18px; margin: 10px 0; font-size: 1.1em; border-radius: 12px; cursor: pointer; border: 2px solid rgba(255,255,255,0.1); transition: 0.2s; font-weight: bold; width: 100%; box-sizing: border-box; }
        .item-card { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; text-align: left; }
        .item-icon { width: 50px; height: 50px; margin-right: 12px; border-radius: 5px; object-fit: cover; background: #000; display: flex; align-items: center; justify-content: center; font-size: 1.2em; border: 1px solid #444; }
        .item-btn { width: 58px; padding: 8px 0; font-size: 0.8em; border-radius: 5px; font-weight: bold; cursor: pointer; border: none; }

        /* ê°•í™” UI */
        #upgrade-target-display { min-height: 80px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; border: 1px dashed #555; font-size: 1.1em; }
        .btn-upgrade { background: var(--point); color: white; height: 55px; font-size: 1.2em; margin-bottom: 8px; font-weight: bold; width: 100%; border: none; border-radius: 10px; cursor: pointer; }
        .btn-upgrade:disabled { background: #444; cursor: not-allowed; }
        #log-container { height: 150px; overflow-y: auto; background: #1a1a2e; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.85em; text-align: left; color: #95a5a6; border: 1px solid #333; }
        
        .grid-5, .grid-4 { display: grid; gap: 8px; margin: 15px 0; }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .cell { aspect-ratio: 1/1; background: #0f3460; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5em; border: 2px solid #1a1a2e; position: relative; }
        .monster-lv { position: absolute; bottom: 1px; right: 1px; font-size: 0.55em; background: rgba(0,0,0,0.8); padding: 1px 3px; border-radius: 3px; }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 1000; }
        .modal-content { position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); background: var(--panel); border: 2px solid var(--point); padding: 15px; border-radius: 12px; width: 90%; max-width: 420px; }
        .btn-nav { background: #444; color: white; margin-top: 5px; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-container">
    <h2 style="color:var(--money);">ğŸ® ê°•í™”í•˜ê¸° ë¡œê·¸ì¸</h2>
    <input type="text" id="login-id" class="login-input" placeholder="ì•„ì´ë””">
    <input type="password" id="login-pw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <div class="auto-login-wrap">
        <input type="checkbox" id="auto-login"> <label for="auto-login">ìë™ ë¡œê·¸ì¸ í™œì„±í™”</label>
    </div>
    <button class="login-btn" onclick="handleLogin()">ì ‘ì†í•˜ê¸°</button>
</div>

<div id="game-container">
    <div class="top-bar">
        <div>ğŸ’° <span id="gold">0</span>G</div>
        <div>ğŸ§ª ë¬¼ì•½: <span id="potion-total">0</span> (<span id="potion-count">0</span>/10)</div>
        <div class="bar-outer">
            <div id="hp-fill"></div>
            <div class="bar-text">â¤ï¸ HP <span id="hp-val">0</span> / <span id="hp-max">0</span></div>
        </div>
        <div class="bar-outer">
            <div id="exp-fill"></div>
            <div class="bar-text">â­ Lv.<span id="user-lv">1</span> (<span id="exp-val">0</span> / <span id="exp-next">0</span>)</div>
        </div>
    </div>

    <div id="page-main" class="page active">
        <h1 style="color:var(--money); margin-bottom:15px; font-size:1.6em;">ê°•í™”í•˜ê¸° v1.1</h1>
        <div style="margin-bottom:10px; font-size:0.9em; color:#aaa;"><strong id="display-user-id" style="color:white;"></strong>ë‹˜ ì ‘ì† ì¤‘</div>
        <div class="main-menu-btn" onclick="showPage('page-earn')">ğŸ’° ê³¨ë“œìˆ˜ê¸‰</div>
        <div class="main-menu-btn" onclick="showPage('page-upgrade')">ğŸ”¨ ê°•í™”í•˜ê¸°</div>
        <div class="main-menu-btn" onclick="showPage('page-info')">ğŸ‘¤ ë‚´ ì •ë³´</div>
        <div class="main-menu-btn" style="background:#c0392b;" onclick="fullHeal()">ğŸ¥ ì¹˜ë£Œì†Œ (ì „ì²´ íšŒë³µ)</div>
        <div class="main-menu-btn" style="background:#ffffff; color:#000000;" onclick="showPage('page-shop-select')">ğŸ›’ ìƒì </div>
        <button onclick="logout()" style="background:none; border:none; color:#555; cursor:pointer; margin-top:20px; text-decoration:underline;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="page-info" class="page">
        <h2>ğŸ‘¤ ë‚´ ì •ë³´</h2>
        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:15px; text-align:left; font-size:0.95em;">
            <p>âš”ï¸ ê³µê²©ë ¥: <span id="info-atk">0</span></p>
            <p>ğŸ›¡ï¸ ë°©ì–´ë ¥: <span id="info-def">0</span></p>
            <p>â¤ï¸ ìµœëŒ€ ì²´ë ¥: <span id="info-hp">0</span></p>
        </div>
        <div id="inventory-list"></div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-upgrade" class="page">
        <h2>ğŸ”¨ ì¥ë¹„ ê°•í™”</h2>
        <div id="upgrade-target-display">ê°•í™”í•  ì¥ë¹„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        <button onclick="openInventoryModal()" style="background:var(--hunt); color:white; margin-bottom:10px; font-size:0.9em; padding:10px; border:none; border-radius:8px; width:100%; cursor:pointer;">ğŸ“¦ ì¸ë²¤í† ë¦¬ íŒì—…</button>
        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; margin-bottom:10px; text-align:left; font-size:0.85em;">
            <h4 style="margin:0 0 8px 0; color:var(--money);">ğŸ›¡ï¸ ë°©ì§€ê¶Œ ì„ íƒ</h4>
            <label><input type="radio" name="prot" value="0" checked> ë¯¸ì‚¬ìš©</label>
            <label><input type="radio" name="prot" value="1"> í•˜ê¸‰(<span id="inv-scroll-1">0</span>)</label>
            <label><input type="radio" name="prot" value="2"> ì¤‘ê¸‰(<span id="inv-scroll-2">0</span>)</label>
            <label><input type="radio" name="prot" value="3"> ìƒê¸‰(<span id="inv-scroll-3">0</span>)</label>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:1em; font-weight:bold;">
            <span style="color:#4ecca3;">ì„±ê³µ <span id="up-chance">0</span>%</span>
            <span style="color:var(--point);">íŒŒê´´ <span id="up-break">0</span>%</span>
        </div>
        <button class="btn-upgrade" id="btn-up-exec" onclick="tryUpgrade()" disabled>ê°•í™”í•˜ê¸° (0G)</button>
        <button class="btn-nav" style="background:#3498db; margin-bottom:5px;" id="auto-btn" onclick="startAutoUpgrade()">ìë™ ê°•í™” (+10ê°•)</button>
        <button class="btn-nav" id="btn-up-sell" style="background:#c0392b; display:none;" onclick="sellFromUpgrade()">ì•„ì´í…œ íŒë§¤</button>
        
        <div id="log-container">ì‹œìŠ¤í…œ: ì¤€ë¹„ ì™„ë£Œ.</div>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <div id="page-earn" class="page">
        <h2>ğŸ’° ê³¨ë“œìˆ˜ê¸‰</h2>
        <button class="main-menu-btn" style="background:var(--hunt);" onclick="showPage('page-hunt')">âš”ï¸ ì‚¬ëƒ¥í„°</button>
        <button class="main-menu-btn" style="background:var(--mine); color:black;" onclick="showPage('page-mine-select')">â›ï¸ ê´‘ì‚°</button>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>
    
    <div id="page-mine-select" class="page">
        <h2>â›ï¸ ê´‘ì‚° ì„ íƒ</h2>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="main-menu-btn" style="background:#7f8c8d;" onclick="enterMine(0)">ê³ ê°ˆëœ ê´‘ì‚°(1,000G)</button>
            <button class="main-menu-btn" style="background:#95a5a6;" onclick="enterMine(1)">ë¬´ë„ˆì§„ ê´‘ì‚°(10,000G)</button>
            <button class="main-menu-btn" style="background:var(--mine); color:black;" onclick="enterMine(2)">ë¹›ë‚˜ëŠ” ê´‘ì‚°(100,000G)</button>
            <button class="main-menu-btn" style="background:#f1c40f; color:black;" onclick="enterMine(3)">ì°¬ë€í•œ ê´‘ì‚°(500,000G)</button>
        </div>
        <button class="btn-nav" onclick="showPage('page-earn')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-mine-play" class="page">
        <h2 id="mine-title">ì±„êµ´ ì¤‘</h2>
        <div id="mine-grid" class="grid-4"></div>
        <button id="mine-refresh" class="btn-nav" style="background:var(--mine); color:black; display:none;" onclick="refreshMine()">ìƒˆ ê´‘ë§¥ íƒìƒ‰</button>
        <button class="btn-nav" onclick="showPage('page-mine-select')">â¬…ï¸ ë‚˜ê°€ê¸°</button>
    </div>

    <div id="page-shop-select" class="page">
        <h2>ğŸ›’ ìƒì </h2>
        <button class="main-menu-btn" onclick="openShop('equip')">âš”ï¸ ì¥ë¹„ ìƒì </button>
        <button class="main-menu-btn" onclick="openShop('consume')">ğŸ§ª ì†Œë¹„ ìƒì </button>
        <button class="btn-nav" onclick="showPage('page-main')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-shop-detail" class="page">
        <h2 id="shop-title">ìƒì </h2>
        <div id="shop-list"></div>
        <button class="btn-nav" onclick="showPage('page-shop-select')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="page-hunt" class="page">
        <h2>âš”ï¸ ì‚¬ëƒ¥í„°</h2>
        <button onclick="scanHunt()" class="main-menu-btn" style="background:var(--hunt);">ğŸ“¡ ëª¬ìŠ¤í„° íƒìƒ‰</button>
        <div id="hunt-grid" class="grid-5"></div>
        <div id="battle-log" style="height:150px; overflow-y:auto; background:#000; padding:10px; font-size:0.8em; margin-top:10px; border-radius:8px;"></div>
        <button class="btn-nav" onclick="showPage('page-earn')">â¬…ï¸ ë’¤ë¡œê°€ê¸°</button>
    </div>

    <div id="inv-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“¦ ì¥ë¹„ ì„ íƒ</h3>
            <div id="modal-item-list"></div>
            <button class="btn-nav" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    /* ==========================================
       1. ë°ì´í„° ë° ì‹œìŠ¤í…œ ì •ì˜
       ========================================== */
    let currentUser = null;
    let data = null;
    let upIdx = -1, autoTimer = null;

    const EQUIP_DB = [
        { lv: 1, name: 'ë‚˜ë¬´ ê²€', k: 1.1, p: 1000, type: 'weapon', img: 'wood_sword.png' },
        { lv: 1, name: 'í—ê±°ìš´ ì˜·', k: 1.0, p: 1000, type: 'armor', img: 'loose_clothes.png' },
        { lv: 1, name: 'ë‚¡ì€ ë²¨íŠ¸', k: 1.0, p: 1000, type: 'belt', img: 'old_belt.png' },
        { lv: 5, name: 'ë‚¡ì€ ê²€', k: 1.2, p: 10000, type: 'weapon' },
        { lv: 5, name: 'ì²œ ì˜·', k: 1.1, p: 10000, type: 'armor' },
        { lv: 5, name: 'ì²œ ë²¨íŠ¸', k: 1.2, p: 10000, type: 'belt' },
        { lv: 10, name: 'ì²  ê²€', k: 1.4, p: 100000, type: 'weapon' },
        { lv: 10, name: 'ì§ˆê¸´ ì˜·', k: 1.3, p: 100000, type: 'armor' },
        { lv: 10, name: 'ì§ˆê¸´ ë²¨íŠ¸', k: 1.5, p: 100000, type: 'belt' },
        { lv: 15, name: 'ê°•ì²  ê²€', k: 1.7, p: 500000, type: 'weapon' },
        { lv: 15, name: 'ê°€ì£½ ì˜·', k: 1.6, p: 500000, type: 'armor' },
        { lv: 15, name: 'ê°€ì£½ ë²¨íŠ¸', k: 1.9, p: 500000, type: 'belt' },
        { lv: 20, name: 'ì—°ë§ˆëœ ê°•ì²  ê²€', k: 2.1, p: 1500000, type: 'weapon' },
        { lv: 20, name: 'ê°•í™” ê°€ì£½ ì˜·', k: 2.0, p: 1500000, type: 'armor' },
        { lv: 20, name: 'ê°•í™” ê°€ì£½ ë²¨íŠ¸', k: 2.5, p: 1500000, type: 'belt' },
        { lv: 25, name: 'ì€ë¹› ê°•ì²  ê²€', k: 2.7, p: 3500000, type: 'weapon' },
        { lv: 25, name: 'ë¹„ëŠ˜ ê°‘ì˜·', k: 2.5, p: 3500000, type: 'armor' },
        { lv: 25, name: 'ê¸ˆì† ì¥ì‹ ë²¨íŠ¸', k: 3.3, p: 3500000, type: 'belt' },
        { lv: 30, name: 'ì€ ê²€', k: 3.5, p: 8000000, type: 'weapon' },
        { lv: 30, name: 'ê°•ì²  ê°‘ì˜·', k: 3.2, p: 8000000, type: 'armor' },
        { lv: 30, name: 'ìš©ë³‘ ë²¨íŠ¸', k: 4.5, p: 8000000, type: 'belt' }
    ];

    const MINE_DATA = [
        { name: 'ê³ ê°ˆëœ ê´‘ì‚°', p: 1000, rates: [0.4, 0.4, 0.2, 0, 0, 0] },
        { name: 'ë¬´ë„ˆì§„ ê´‘ì‚°', p: 10000, rates: [0.4, 0.2, 0.3, 0.1, 0, 0] },
        { name: 'ë¹›ë‚˜ëŠ” ê´‘ì‚°', p: 100000, rates: [0.4, 0.1, 0.2, 0.25, 0.05, 0] },
        { name: 'ì°¬ë€í•œ ê´‘ì‚°', p: 500000, rates: [0.39, 0.1, 0.15, 0.2, 0.15, 0.01] }
    ];
    
    const ORE_INFO = [
        { n: 'ë¹ˆê³µê°„', v: 0, s: '' },
        { n: 'ëŒ', v: 1000, s: 'ğŸª¨' },
        { n: 'êµ¬ë¦¬', v: 2000, s: 'ğŸ¥‰' },
        { n: 'ì€', v: 20000, s: 'ğŸ¥ˆ' },
        { n: 'ê¸ˆ', v: 100000, s: 'ğŸ¥‡' },
        { n: 'ë‹¤ì´ì•„ëª¬ë“œ', v: 2000000, s: 'ğŸ’' }
    ];

    const createNewChar = () => ({
        version: "1.1", level: 1, exp: 0, gold: 10000, hp: 100,
        potions: 0, potionCount: 0,
        equipment: { weapon: null, armor: null, belt: null },
        inventory: [], scrolls: { item1: 0, item2: 0, item3: 0 }
    });

    /* ==========================================
       2. ë¡œê·¸ì¸ & ìë™ ë¡œê·¸ì¸ ë¡œì§
       ========================================== */
    const handleLogin = () => {
        const id = document.getElementById('login-id').value;
        const pw = document.getElementById('login-pw').value;
        const isAuto = document.getElementById('auto-login').checked;

        if(!id || !pw) return alert("ì…ë ¥ ì •ë³´ ë¶€ì¡±!");

        const users = JSON.parse(localStorage.getItem('game_users') || "{}");

        if(users[id]) {
            if(users[id].pw !== pw) return alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜!");
            data = users[id].data;
        } else {
            users[id] = { pw: pw, data: createNewChar() };
            data = users[id].data;
        }

        currentUser = id;
        if(isAuto) localStorage.setItem('game_auto_user', id);
        else localStorage.removeItem('game_auto_user');

        localStorage.setItem('game_users', JSON.stringify(users));
        enterGame();
    };

    const enterGame = () => {
        document.getElementById('display-user-id').innerText = currentUser;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        updateUI();
    };

    const logout = () => {
        saveGame();
        localStorage.removeItem('game_auto_user');
        location.reload();
    };

    const saveGame = () => {
        if(!currentUser) return;
        const users = JSON.parse(localStorage.getItem('game_users') || "{}");
        users[currentUser].data = data;
        localStorage.setItem('game_users', JSON.stringify(users));
    };

    /* ==========================================
       3. ê²Œì„ í•µì‹¬ ê¸°ëŠ¥
       ========================================== */
    const getBaseAtk = lv => 10 + 0.5 * Math.pow(lv - 1, 1.2);
    const getBaseDef = lv => 2 + 0.1 * Math.pow(lv - 1, 1.1);
    const getBaseMaxHP = lv => 100 + 5 * Math.pow(lv - 1, 1.3);
    
    const getFinalStats = () => {
        if(!data) return { atk:0, def:0, hp:0 };
        let bAtk = getBaseAtk(data.level), bDef = getBaseDef(data.level), bHP = getBaseMaxHP(data.level);
        let fAtk = bAtk, fDef = bDef, fHP = bHP;
        if(data.equipment.weapon) fAtk = bAtk * data.equipment.weapon.k * (1 + 0.2 * Math.pow(data.equipment.weapon.en, 1.1));
        if(data.equipment.armor) fDef = bDef * data.equipment.armor.k * (1 + 0.5 * data.equipment.armor.en);
        if(data.equipment.belt) fHP = bHP * data.equipment.belt.k * (1 + 0.1 * Math.pow(data.equipment.belt.en, 1.25));
        return { atk: fAtk, def: fDef, hp: fHP };
    };

    const updateUI = () => {
        if(!data) return;
        const stats = getFinalStats();
        document.getElementById('gold').innerText = Math.floor(data.gold).toLocaleString();
        document.getElementById('potion-total').innerText = Math.floor(data.potions).toLocaleString();
        document.getElementById('hp-val').innerText = Math.floor(data.hp).toLocaleString();
        document.getElementById('hp-max').innerText = Math.floor(stats.hp).toLocaleString();
        document.getElementById('hp-fill').style.width = (data.hp / stats.hp * 100) + '%';
        document.getElementById('user-lv').innerText = data.level;
        document.getElementById('exp-val').innerText = Math.floor(data.exp).toLocaleString();
        const next = data.level * 100 * 1.4;
        document.getElementById('exp-next').innerText = Math.floor(next).toLocaleString();
        document.getElementById('exp-fill').style.width = (data.exp / next * 100) + '%';
        
        document.getElementById('info-atk').innerText = Math.floor(stats.atk).toLocaleString();
        document.getElementById('info-def').innerText = Math.floor(stats.def).toLocaleString();
        document.getElementById('info-hp').innerText = Math.floor(stats.hp).toLocaleString();
        renderInventory();
    };

    const goToUpgrade = (idx) => {
        selectUpgrade(idx);
        showPage('page-upgrade');
    };

    const renderInventory = () => {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        data.inventory.forEach((it, idx) => {
            const isEquipped = (data.equipment[it.type] && data.equipment[it.type].id === it.id);
            const card = document.createElement('div');
            card.className = 'item-card';
            const imgHtml = it.img ? `<img src="image/${it.img}" class="item-icon">` : '<div class="item-icon">?</div>';
            card.innerHTML = `
                ${imgHtml}
                <div style="flex:1;">
                    <strong>${it.name} +${it.en}</strong> ${isEquipped ? '<span style="color:var(--mine)">[E]</span>' : ''}<br>
                    <small style="color:#aaa;">${it.type}</small>
                </div>
                <div style="display:flex; flex-direction:row; gap:4px;">
                    <button class="item-btn" style="background:var(--money); color:black;" onclick="goToUpgrade(${idx})">ê°•í™”</button>
                    <button class="item-btn" style="background:var(--hunt); color:white;" onclick="toggleEquip(${idx})">${isEquipped ? 'í•´ì œ' : 'ì¥ì°©'}</button>
                    <button class="item-btn" style="background:#c0392b; color:white;" onclick="confirmSell(${idx})">íŒë§¤</button>
                </div>
            `;
            list.appendChild(card);
        });
    };

    /* ìš”êµ¬ì‚¬í•­: íŒë§¤ ì „ í™•ì¸ íŒì—… */
    const confirmSell = (idx) => {
        const it = data.inventory[idx];
        const sellPrice = Math.floor(it.p * 0.5);
        if(confirm(`ì •ë§ë¡œ '${it.name} +${it.en}'ì„(ë¥¼) ${sellPrice.toLocaleString()}Gì— íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            data.gold += sellPrice;
            if(data.equipment[it.type] && data.equipment[it.type].id === it.id) data.equipment[it.type] = null;
            data.inventory.splice(idx, 1);
            if(upIdx === idx) { upIdx = -1; resetUpgradeUI(); }
            updateUI();
            saveGame();
        }
    };

    const selectUpgrade = (idx) => {
        upIdx = idx;
        const it = data.inventory[idx];
        const cost = Math.floor(it.p * 0.5 * Math.pow(1.5, it.en));
        document.getElementById('upgrade-target-display').innerHTML = `<strong>${it.name} +${it.en}</strong>`;
        document.getElementById('btn-up-exec').innerText = `ê°•í™”í•˜ê¸° (${cost.toLocaleString()}G)`;
        document.getElementById('btn-up-exec').disabled = false;
        document.getElementById('btn-up-sell').style.display = 'block'; // íŒë§¤ ë²„íŠ¼ ë…¸ì¶œ
        const sc = it.en < 3 ? 100 : it.en < 6 ? 85 : it.en < 9 ? 60 : 40;
        const bc = it.en >= 7 ? 20 : (it.en >= 5 ? 5 : 0);
        document.getElementById('up-chance').innerText = sc;
        document.getElementById('up-break').innerText = bc;
        closeModal();
    };

    const sellFromUpgrade = () => {
        if(upIdx !== -1) confirmSell(upIdx);
    };

    const resetUpgradeUI = () => {
        document.getElementById('upgrade-target-display').innerText = 'ê°•í™” ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.';
        document.getElementById('btn-up-exec').disabled = true;
        document.getElementById('btn-up-sell').style.display = 'none';
    };

    const tryUpgrade = () => {
        if(upIdx === -1) return;
        const it = data.inventory[upIdx];
        const cost = Math.floor(it.p * 0.5 * Math.pow(1.5, it.en));
        if(data.gold < cost) { stopAuto(); return alert("ê³¨ë“œ ë¶€ì¡±!"); }
        data.gold -= cost;
        const sc = it.en < 3 ? 100 : it.en < 6 ? 85 : it.en < 9 ? 60 : 40;
        const bc = (it.en >= 7 ? 20 : (it.en >= 5 ? 5 : 0));
        if(Math.random()*100 < sc) {
            it.en++;
            addLog(`ì„±ê³µ: +${it.en} ê°•í™”!`, 'var(--mine)');
        } else {
            if(Math.random()*100 < bc) {
                data.inventory.splice(upIdx, 1);
                addLog(`íŒŒê´´: ${it.name} ì†Œë©¸`, 'red');
                upIdx = -1; stopAuto(); resetUpgradeUI();
            } else {
                it.en = Math.max(0, it.en - 1);
                addLog('ì‹¤íŒ¨: ë‹¨ê³„ í•˜ë½', '#aaa');
            }
        }
        updateUI();
        if(upIdx !== -1) selectUpgrade(upIdx);
    };

    const startAutoUpgrade = () => {
        if(autoTimer) stopAuto();
        else { autoTimer = setInterval(tryUpgrade, 100); document.getElementById('auto-btn').innerText = 'ì¤‘ë‹¨'; }
    };
    const stopAuto = () => { clearInterval(autoTimer); autoTimer = null; document.getElementById('auto-btn').innerText = 'ìë™ ê°•í™” (+10ê°•)'; };

/* ==========================================
       4. ì‚¬ëƒ¥ ë° ì „íˆ¬ ì‹œìŠ¤í…œ (í„´ì œ ìë™ ì „íˆ¬)
       ========================================== */
    const getMonsterStats = (lv) => {
        const MON_BASE = [
            { lv: 1, hp: 280, atk: 25, def: 5, gold: 100, exp: 10 },
            { lv: 5, hp: 380, atk: 35, def: 8, gold: 1000, exp: 50 },
            { lv: 10, hp: 650, atk: 55, def: 15, gold: 7000, exp: 100 },
            { lv: 15, hp: 1200, atk: 95, def: 30, gold: 10000, exp: 150 },
            { lv: 20, hp: 2200, atk: 160, def: 55, gold: 15000, exp: 200 },
            { lv: 25, hp: 4200, atk: 300, def: 100, gold: 30000, exp: 300 },
            { lv: 30, hp: 7500, atk: 550, def: 180, gold: 50000, exp: 500 }
        ];

        let low = MON_BASE[0], high = MON_BASE[MON_BASE.length - 1];
        for (let i = 0; i < MON_BASE.length - 1; i++) {
            if (lv >= MON_BASE[i].lv && lv <= MON_BASE[i + 1].lv) {
                low = MON_BASE[i]; high = MON_BASE[i + 1]; break;
            }
        }
        const ratio = (lv - low.lv) / (high.lv - low.lv || 1);
        const lerp = (a, b) => a + (b - a) * ratio;
        return {
            lv,
            hp: lerp(low.hp, high.hp),
            atk: lerp(low.atk, high.atk),
            def: lerp(low.def, high.def),
            gold: lerp(low.gold, high.gold),
            exp: lerp(low.exp, high.exp)
        };
    };

    const scanHunt = () => {
        const grid = document.getElementById('hunt-grid');
        grid.innerHTML = '';
        for (let i = 0; i < 5; i++) {
            const lv = Math.max(1, data.level + Math.floor(Math.random() * 11) - 5);
            const m = getMonsterStats(lv);
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerHTML = `ğŸ‘¾<span class="monster-lv">Lv.${lv}</span>`;
            cell.onclick = () => startBattle(m);
            grid.appendChild(cell);
        }
    };

    const startBattle = (m) => {
        if (data.hp <= 0) return alert('ì¹˜ë£Œì†Œì—ì„œ íšŒë³µì´ í•„ìš”í•©ë‹ˆë‹¤!');
        const logBox = document.getElementById('battle-log');
        logBox.innerHTML = `[ì‹œìŠ¤í…œ] Lv.${m.lv} ëª¬ìŠ¤í„°ì™€ ì¡°ìš°í–ˆìŠµë‹ˆë‹¤.<br>`;
        const pStats = getFinalStats();
        let mHP = m.hp;

        const battleItv = setInterval(() => {
            const calcDmg = (a, d) => (a >= d) ? (a * 2 - d) : (Math.pow(a, 2) / d);
            
            // ìœ ì € í„´
            const pDmg = Math.floor(calcDmg(pStats.atk, m.def));
            mHP -= pDmg;
            logBox.innerHTML = `ìœ ì €ëŠ” ê³µê²©í–ˆë‹¤. ${pDmg}ì˜ ë°ë¯¸ì§€ (ë‚¨ì€ ì  ì²´ë ¥ : ${Math.max(0, Math.floor(mHP))})<br>` + logBox.innerHTML;
            
            if (mHP <= 0) {
                clearInterval(battleItv);
                data.gold += m.gold;
                data.exp += m.exp;
                logBox.innerHTML = `<span style="color:var(--money)">ìŠ¹ë¦¬! íšë“ ê³¨ë“œ +${Math.floor(m.gold)}G, íšë“ ê²½í—˜ì¹˜ +${Math.floor(m.exp)}EXP</span><br>` + logBox.innerHTML;
                checkLevelUp();
                updateUI();
                saveGame();
                return;
            }

            // ëª¬ìŠ¤í„° í„´
            const mDmg = Math.floor(calcDmg(m.atk, pStats.def));
            data.hp -= mDmg;
            
            // ë¬¼ì•½ ìë™ ì‚¬ìš© ë¡œì§
            if (data.potions > 0 && data.hp < pStats.hp) {
                const healAmt = Math.min(mDmg, data.potions);
                data.hp += healAmt;
                data.potions -= healAmt;
                if (data.potions <= 0) data.potionCount = 0;
            }
            
            logBox.innerHTML = `ê³µê²©ë°›ì•˜ë‹¤. ${mDmg}ì˜ ë°ë¯¸ì§€ (ë‚¨ì€ ì²´ë ¥ : ${Math.max(0, Math.floor(data.hp))})<br>` + logBox.innerHTML;
            
            if (data.hp <= 0) {
                clearInterval(battleItv);
                data.hp = 0;
                logBox.innerHTML = `<span style="color:red">íŒ¨ë°°... ë§ˆì„ë¡œ í›„í‡´í•©ë‹ˆë‹¤.</span><br>` + logBox.innerHTML;
                updateUI();
                saveGame();
            }
        }, 100);
    };

    const checkLevelUp = () => {
        const getNextExp = lv => lv * 100 * 1.4;
        while (data.exp >= getNextExp(data.level)) {
            data.exp -= getNextExp(data.level);
            data.level++;
            alert(`ë ˆë²¨ì—…! í˜„ì¬ Lv.${data.level}ì…ë‹ˆë‹¤.`);
        }
    };

    /* ==========================================
       5. ê´‘ì‚° ì‹œìŠ¤í…œ (4x4 ê·¸ë¦¬ë“œ ì±„êµ´)
       ========================================== */
    const enterMine = (tier) => {
        const cost = MINE_DATA[tier].p;
        if (data.gold < cost) return alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
        data.gold -= cost;
        data.currentMineTier = tier;
        generateMine();
        showPage('page-mine-play');
        updateUI();
        saveGame();
    };

    const generateMine = () => {
        const rates = MINE_DATA[data.currentMineTier].rates;
        data.mineGrid = [];
        for (let i = 0; i < 16; i++) {
            const r = Math.random();
            let acc = 0, type = 0;
            for (let j = 0; j < rates.length; j++) {
                acc += rates[j];
                if (r < acc) { type = j; break; }
            }
            data.mineGrid.push(type);
        }
        renderMine();
    };

    const renderMine = () => {
        const grid = document.getElementById('mine-grid');
        grid.innerHTML = '';
        let oresLeft = false;
        data.mineGrid.forEach((idx, i) => {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const ore = ORE_INFO[idx];
            cell.innerText = ore.s;
            if (idx > 0) {
                oresLeft = true;
                cell.onclick = () => {
                    data.gold += ore.v;
                    data.mineGrid[i] = 0;
                    renderMine(); updateUI(); saveGame();
                };
            }
            grid.appendChild(cell);
        });
        document.getElementById('mine-refresh').style.display = oresLeft ? 'none' : 'block';
    };

    const refreshMine = () => enterMine(data.currentMineTier);

    /* ==========================================
       6. ìƒì  ì‹œìŠ¤í…œ (ì¥ë¹„ ë° ì†Œë¹„ ì•„ì´í…œ)
       ========================================== */
    const openShop = (cat) => {
        showPage('page-shop-detail');
        const list = document.getElementById('shop-list');
        list.innerHTML = '';
        if (cat === 'equip') {
            document.getElementById('shop-title').innerText = 'ì¥ë¹„ ìƒì ';
            EQUIP_DB.forEach(proto => {
                const card = document.createElement('div');
                card.className = 'item-card';
                const imgHtml = proto.img ? `<img src="image/${proto.img}" class="item-icon">` : '<div class="item-icon">?</div>';
                card.innerHTML = `${imgHtml}<div style="flex:1;"><strong>${proto.name}</strong> (Lv.${proto.lv})<br>${proto.p.toLocaleString()}G</div>
                    <button class="item-btn" style="background:var(--money); color:black;" onclick="buyItem('equip', ${JSON.stringify(proto).replace(/"/g, '&quot;')})">êµ¬ë§¤</button>`;
                list.appendChild(card);
            });
        } else {
            document.getElementById('shop-title').innerText = 'ì†Œë¹„ ìƒì ';
            // ë¬¼ì•½ ë¦¬ìŠ¤íŠ¸
            const potTiers = [{n:'ìµœí•˜ê¸‰',r:100,p:2000},{n:'í•˜ê¸‰',r:1000,p:20000},{n:'ì¤‘ê¸‰',r:5000,p:100000},{n:'ìƒê¸‰',r:10000,p:200000},{n:'ìµœìƒê¸‰',r:50000,p:1000000}];
            potTiers.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `<img src="image/health_potion_${i+1}.png" class="item-icon"><div style="flex:1;"><strong>${p.n} ë¬¼ì•½</strong> (íšŒë³µ:${p.r.toLocaleString()})<br>${p.p.toLocaleString()}G</div>
                    <button class="item-btn" style="background:var(--mine); color:black;" onclick="buyItem('potion', ${p.r}, ${p.p})">êµ¬ë§¤</button>`;
                list.appendChild(card);
            });
            // ë°©ì§€ê¶Œ ë¦¬ìŠ¤íŠ¸
            const scrolls = [{n:'í•˜ê¸‰ ë°©ì§€ê¶Œ',t:1,p:100000},{n:'ì¤‘ê¸‰ ë°©ì§€ê¶Œ',t:2,p:500000},{n:'ìƒê¸‰ ë°©ì§€ê¶Œ',t:3,p:2000000}];
            scrolls.forEach(s => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `<img src="image/scroll_${s.t}.png" class="item-icon"><div style="flex:1;"><strong>${s.n}</strong><br>${s.p.toLocaleString()}G</div>
                    <button class="item-btn" style="background:var(--hunt); color:white;" onclick="buyItem('scroll', ${s.t}, ${s.p})">êµ¬ë§¤</button>`;
                list.appendChild(card);
            });
        }
    };

    const buyItem = (type, v1, v2) => {
        if (type === 'equip') {
            if (data.gold < v1.p) return alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
            data.gold -= v1.p;
            data.inventory.push({ ...v1, en: 0, id: Date.now() + Math.random() });
        } else if (type === 'potion') {
            if (data.gold < v2) return alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
            if (data.potionCount >= 10) return alert('ìµœëŒ€ 10ê°œ ì†Œì§€ ê°€ëŠ¥!');
            data.gold -= v2;
            data.potions += v1;
            data.potionCount += 1;
        } else {
            if (data.gold < v2) return alert('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
            data.gold -= v2;
            data.scrolls['item' + v1]++;
        }
        updateUI();
        saveGame();
    };
    const showPage = (id) => { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); updateUI(); saveGame(); };
    const closeModal = () => document.getElementById('inv-modal').style.display = 'none';
    const openInventoryModal = () => { 
        document.getElementById('inv-modal').style.display = 'block'; 
        const list = document.getElementById('modal-item-list');
        list.innerHTML = '';
        data.inventory.forEach((it, idx) => {
            const card = document.createElement('div'); card.className = 'item-card';
            card.innerHTML = `<div><strong>${it.name} +${it.en}</strong></div><button class="item-btn" style="background:var(--hunt); color:white;" onclick="selectUpgrade(${idx})">ì„ íƒ</button>`;
            list.appendChild(card);
        });
    };
    const addLog = (m, c) => { const l = document.getElementById('log-container'); l.innerHTML = `<div style="color:${c}">> ${m}</div>` + l.innerHTML; };
    const fullHeal = () => { data.hp = getFinalStats().hp; updateUI(); alert('íšŒë³µ ì™„ë£Œ!'); };
    const toggleEquip = (idx) => {
        const it = data.inventory[idx];
        if(data.equipment[it.type] && data.equipment[it.type].id === it.id) data.equipment[it.type] = null;
        else data.equipment[it.type] = it;
        if(data.hp > getFinalStats().hp) data.hp = getFinalStats().hp;
        updateUI();
    };

    /* ì´ˆê¸° ìë™ ë¡œê·¸ì¸ ì²´í¬ */
    window.onload = () => {
        const autoUserId = localStorage.getItem('game_auto_user');
        if(autoUserId) {
            const users = JSON.parse(localStorage.getItem('game_users') || "{}");
            if(users[autoUserId]) {
                currentUser = autoUserId;
                data = users[autoUserId].data;
                enterGame();
            }
        }
    };
</script>
</body>
</html>


